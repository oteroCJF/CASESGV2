@model CedulasEvaluacion.Entities.MCedula.CedulaEvaluacion
@{
    ViewData["Title"] = "Revisión a la Cédula del Servicio de Mensajería Acelerada: " + Model.Folio;
    int i = 0, p = 0, cf = 0, f = 0;
    double totalServicios = 0, totalServiciosNC = 0;
    decimal totalConceptos = 0, totalIVA = 0, tp = 0;
    decimal totalConceptosNC = 0, totalIVANC = 0;
}

<div class="row col-lg-12">
    <div class="col-lg-12">
        <a href="/mensajeria/index/@Model.ServicioId@Model.URL" type='button' class='btn-sm btn-warning float-right mr-2 mb-3'><i class="fal fa-arrow-left"></i></a>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <ul class="nav nav-tabs h6" id="myTab" role="tablist">
            @foreach (var pr in Model.pestanas)
            {
                if (pr.NoPregunta == 0)
                {
                    <li class="nav-item" role="presentation">
                        <a class="nav-link @(pr.Abreviacion.Equals("InformacionGeneral") ? "active":"")" id="@(pr.Abreviacion.Equals("InformacionGeneral") ? "home-tab":"profile-tab")" data-toggle="tab" href="#@pr.Abreviacion" role="tab" aria-controls="home" aria-selected="true">
                            @pr.Valor
                        </a>
                    </li>
                }
                else
                {
                    p++;
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#@pr.Abreviacion.Replace(" ","") " role="tab" aria-controls="profile" aria-selected="false">
                            @(pr.Tipo.Equals("Incidencia") ? "Pregunta "+p :pr.Valor)
                        </a>
                    </li>
                }
            }
        </ul>
        <div class="tab-content" id="myTabContent">
            @foreach (var pr in Model.pestanas)
            {
                p++;
                @if (pr.Abreviacion.Equals("InformacionGeneral"))
                {
                    <div class="tab-pane fade show active" id="@pr.Abreviacion" role="tabpanel" aria-labelledby="home-tab">
                        <div class="row justify-content-center align-items-center mt-4">
                            <div class="col-lg-12 h3 ml-4">
                                Información General
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 mt-3">
                                <div class="card bg-light d-flex flex-fill">
                                    <div class="card-header border-bottom-0">
                                        <h2 class="lead"><b>Inmueble Evaluado: </b> @Model.inmuebles.Nombre</h2>
                                    </div>
                                    <div class="card-body pt-0">
                                        <div class="row">
                                            <div class="col-lg-7 mr-2">
                                                <p class="text-medium">Evaluación correspondiente al mes <b>@Model.Mes</b> del año <b>@Model.Anio</b></p>
                                                <ul class="ml-4 mb-0 fa-ul">
                                                    <li class="medium mt-3"><span class="fa-li"><i class="fas fa-lg fa-dollar-sign"></i></span> <b>Facturación Total: </b>: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.TotalMontoFactura)</li>
                                                    <li class="medium mt-3"><span class="fa-li"><i class="fad fa-star"></i></span> <b>Calificación: </b> @Model.Calificacion</li>
                                                    <li class="medium mt-3"><span class="fa-li"><i class="fas fa-lg fa-user"></i></span> <b>Elaboró: </b> @Model.usuarios.nombre_emp @Model.usuarios.paterno_emp @Model.usuarios.materno_emp</li>
                                                    <li class="medium mt-3">
                                                        <span class="fa-li"><i class="fas fa-lg fa-envelope mb-1"></i></span>
                                                        <strong>Correo:</strong>
                                                        @if (@Model.usuarios.correo_electronico.Equals("") || @Model.usuarios.correo_electronico.Equals(null))
                                                        {
                                                            <strong class="text-danger">@String.Format("Sin correo")</strong>
                                                        }
                                                        else
                                                        {
                                                            @Model.usuarios.correo_electronico
                                                        }
                                                        <a href="#" id="btn_correo" class='btn-xs btn-primary ml-2' data-toggle="tooltip" title="Actualizar Correo Electrónico" data-placement="top">
                                                            <i class="fal fa-edit"></i>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-lg-4">
                                                <h5 class="@(Model.Fondo.Replace("bg", "text")) lblEstatus">
                                                    @Html.Raw(Model.Icono)
                                                    <strong class="ml-2">Estatus: </strong> @Model.Estatus
                                                </h5>
                                            </div>
                                        </div>
                                    </div>
                                    @if (Model.Estatus.Equals("Enviado a DAS"))
                                    {
                                        <div class="card-footer">
                                            <div class="text-right">
                                                <button href="" class="btn btn-danger float-right mr-3 failed_cedula"><i class="fas fa-times mr-2"></i>Rechazar Cédula</button>
                                                <button href="" class="btn btn-success float-right mr-3 success_cedula"><i class="fas fa-check mr-2"></i>Aceptar Cédula</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (pr.Abreviacion.Equals("facturacion"))
                {
                    <div class="tab-pane fade mt-2 ml-3" id="facturacion" role="tabpanel" aria-labelledby="profile-tab">
                        <div class="col-lg-12 h3 mt-4">
                            Facturación del Servicio
                        </div>
                        <div class="row">
                            <div class="row col-lg-12">
                                <p class="text-justify ml-3">
                                    <strong style="color: dodgerblue;">NOTA: </strong>Favor de revisar que los <strong style="color: dodgerblue;"> datos de la cédula </strong> resaltados en color <strong style="color: dodgerblue;">Azul </strong> coincidan con
                                    la información de la factura que fue agregada.
                                </p>
                                <div class="col-lg-12 mt-3 ml-2">
                                    <table class="table tblIncidencias tablaFacturas" width="100%">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Tipo</th>
                                                <th>Empresa</th>
                                                <th>Folio Fiscal</th>
                                                <th>Número Factura</th>
                                                <th>Subtotal Factura</th>
                                                <th>IVA</th>
                                                <th>Total</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="AA">
                                            @foreach (var fac in Model.facturas)
                                            {
                                                f++;
                                                <tr>
                                                    <td>@f</td>
                                                    <td>@(fac.Tipo.Equals("NC") ? "Nota de Crédito":fac.Tipo)</td>
                                                    <td>@fac.emisor.Nombre</td>
                                                    <td>
                                                        @fac.timbreFiscal.UUID
                                                        @if (!fac.cfdiRelacionado.UUID.Equals(""))
                                                        {
                                                            <p>Relacionado al Folio Fiscal: @fac.cfdiRelacionado.UUID</p>
                                                        }
                                                    </td>
                                                    <td>@fac.comprobante.Folio</td>
                                                    <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.comprobante.SubTotal)</td>
                                                    <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.traslado.Importe)</td>
                                                    <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.comprobante.Total)</td>
                                                    <td class="text-center">
                                                        <a href="#" class="viewConceptosF" id="viewConceptos_@fac.Id" data-factura="@fac.Id">
                                                            <i class="fas fa-eye text-success"></i>
                                                        </a>
                                                        <a target="_blank" href="/facturas/download/@fac.Id/@fac.Tipo" class="ml-2" data-id="@fac.Id">
                                                            <i class='fa-solid fa-download text-danger'></i>
                                                        </a>
                                                        @if (fac.Tipo.Equals("NC") && (Model.Estatus.Equals("Autorizada") || Model.Estatus.Equals("Trámite Rechazado")))
                                                        {
                                                            <a href="#" class="eliminarFactura ml-2" data-factura="@fac.Id" data-folio="@fac.comprobante.Serie@fac.comprobante.Folio" data-toggle="tooltip" title="Eliminar Nota de Crédito" data-placement="top">
                                                                <i class="fas fa-times text-danger"></i>
                                                            </a>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-lg-12 mt-3 ml-2 mb-3">
                                    @foreach (var fac in Model.facturas)
                                    {
                                        <div class="conceptosFactura" id="conceptoFactura_@fac.Id">
                                            <h3>Conceptos de la Factura con Folio: @fac.comprobante.Folio</h3>
                                            <table id="@fac.comprobante.Folio" style="width: 90%" class="table tableConceptos mt-3 float-right">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Cantidad</th>
                                                        <th>Unidad</th>
                                                        <th>Descripción</th>
                                                        <th>Precio Unitario</th>
                                                        <th>SubTotal</th>
                                                        <th>IVA</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var con in fac.concepto)
                                                    {
                                                        if (@fac.Id == con.FacturaId)
                                                        {
                                                            cf++;
                                                            <tr>
                                                                <td>@cf</td>
                                                                <td>@con.Cantidad</td>
                                                                <td>@con.Unidad</td>
                                                                <td>@con.Descripcion</td>
                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.ValorUnitario)</td>
                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Importe)</td>
                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.IVA)</td>
                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Importe + con.IVA)</td>
                                                            </tr>
                                                            @if (fac.Tipo.Equals("NC"))
                                                            {
                                                                totalServiciosNC = totalServiciosNC + Convert.ToDouble(con.Cantidad);
                                                                totalConceptosNC = totalConceptosNC + con.Importe;
                                                                totalIVANC = totalIVANC + Convert.ToDecimal(con.IVA.ToString("N2"));
                                                            }
                                                            else
                                                            {
                                                                totalServicios = totalServicios + Convert.ToDouble(con.Cantidad);
                                                                totalConceptos = totalConceptos + con.Importe;
                                                                totalIVA = totalIVA + Convert.ToDecimal(con.IVA.ToString("N2"));
                                                            }
                                                        }
                                                    }
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        @if (fac.Tipo.Equals("NC"))
                                                        {
                                                            <th>Total:</th>
                                                            <th>@totalServiciosNC - Servicio(s)</th>
                                                            <th colspan="3"></th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalConceptosNC)</th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalIVANC)</th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", (totalConceptosNC + totalIVANC))</th>
                                                        }
                                                        else
                                                        {
                                                            <th>Total:</th>
                                                            <th>@totalServicios - Servicio(s)</th>
                                                            <th colspan="3"></th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalConceptos)</th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalIVA)</th>
                                                            <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", (totalConceptos + totalIVA))</th>
                                                        }
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (pr.Abreviacion.Equals("Entregables"))
                {
                    <div class="tab-pane fade" id="Entregables" role="tabpanel" aria-labelledby="contact-tab">
                        <div class="col-lg-12 h3 mt-4">
                            Entregables Adjuntados
                        </div>
                        <div class="row col-lg-12">
                            <div class="col-lg-8">
                                <p class="h6">El usuario adjunto los siguientes entregables.</p>
                            </div>
                        </div>
                        <div class="row col-lg-12 mt-2 h6">
                            <div class="col-lg-12">
                                <h6 class="mt-4"><strong>Entregables Adjuntos</strong></h6>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Nombre</th>
                                            <th>Fecha de la Incidencia</th>
                                            <th>Ver</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var entre in @Model.iEntregables)
                                        {
                                            <tr>
                                                <td>@entre.TipoEntregable</td>
                                                <td>@entre.NombreArchivo</td>
                                                <td>@entre.FechaCreacion.ToString("yyyy-MM-dd")</td>
                                                <td>
                                                    <a href='#' class='text-center mr-2 view_file' data-id="@entre.Id" data-file="@entre.NombreArchivo" data-tipo="@entre.Tipo">
                                                        <i class='fas fa-eye text-success'></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else if (pr.Abreviacion.Equals("DecutivasPenalizacion"))
                {
                    <div class="tab-pane fade" id="DecutivasPenalizacion" role="tabpanel" aria-labelledby="contact-tab">
                        <div class="col-lg-12 h3 mt-4 mb-4">
                            Penalizaciones y Deductivas
                        </div>
                        <div class="row col-lg-12 mt-2 h6">
                            @if (Model.TotalDeductivas != 0 || Model.TotalPenalizaciones != 0)
                            {
                                <div class="card-header border-bottom-0">
                                    <h2 class="lead"><b>Inmueble Evaluado: </b> @Model.inmuebles.Nombre</h2>
                                    <p class="text-medium">Evaluación correspondiente al mes <b>@Model.Mes</b> del año <b>@Model.Anio</b></p>
                                    <p class="text-justify text-primary font-weight-bold h5">Solicitar al prestador de servicios la nota de crédito por el(los) siguiente(s) concepto(s):</p>
                                </div>
                                <div class="row col-lg-12 @(Model.TotalDeductivas != 0?"text-danger":"text-success") ml-2 font-weight-bold h4">
                                    <p>Deductivas del Servicio</p>
                                </div>
                                @if (Model.TotalDeductivas != 0)
                                {
                                    <div class="row col-lg-12 ml-2">
                                        @foreach (var pd in Model.penalizaciones)
                                        {
                                            @if (pd.TipoDeduccion.Equals("Deductiva") && pd.MontoPenalizacion != 0)
                                            {
                                                <div class="col-lg-3 mb-3">
                                                    @Html.Raw(pd.Icono)
                                                    <b>@pd.Valor: </b>
                                                    <b class="@(@pd.MontoPenalizacion == 0 ? "text-pagado" : "text-danger")">
                                                        @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @pd.MontoPenalizacion)
                                                    </b>
                                                </div>
                                            }
                                        }
                                        @if (Model.PenaCalificacion != 0)
                                        {
                                            <div class="col-lg-4">
                                                <i class="fas fa-star"></i>
                                                <b>Desempeño en el servicio:</b> <b class="text-danger">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @Model.PenaCalificacion)</b>
                                            </div>
                                        }
                                        <div class="row col-lg-12 mt-3">
                                            <div class="col-lg-12">
                                                <h6 class="text-success">
                                                    <b>Total de Deductivas: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @Model.TotalDeductivas)</b>
                                                </h6>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="row col-lg-12">
                                        <div class="text-center col-lg-12 h5">
                                            <b class="text-success">No se presentaron deductivas en el mes de evaluación.</b>
                                        </div>
                                    </div>
                                }
                                <div class="row col-lg-12 @(Model.TotalPenalizaciones != 0?"text-danger":"text-success") ml-2 mt-4 font-weight-bold h4">
                                    <p>Penalizaciones del Servicio</p>
                                </div>
                                @if (Model.TotalPenalizaciones != 0)
                                {
                                    <div class="row col-lg-12 ml-2">
                                        @foreach (var pd in Model.penalizaciones)
                                        {
                                            @if (pd.TipoDeduccion.Equals("Penalizacion") && pd.MontoPenalizacion != 0)
                                            {
                                                <div class="col-lg-3 mb-3">
                                                    @Html.Raw(pd.Icono)
                                                    <b>@pd.Valor: </b>
                                                    <b class="@(@pd.MontoPenalizacion == 0 ? "text-pagado" : "text-danger")">
                                                        @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @pd.MontoPenalizacion)
                                                    </b>
                                                </div>
                                            }
                                        }
                                        <div class="row col-lg-12 mt-2">
                                            <div class="col-lg-12">
                                                <h6 class="text-success">
                                                    <b>Total de Penalizaciones: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.TotalPenalizaciones)</b>
                                                </h6>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="row col-lg-12">
                                        <div class="text-center col-lg-12 h5">
                                            <b class="text-success">No se presentaron penalizaciones en el mes de evaluación.</b>
                                        </div>
                                    </div>
                                }
                                <div class="row col-lg-12 mt-4 ml-1">
                                    <div class="col-lg-12">
                                        <h5 class="text-danger">
                                            <b>Total de deductivas y penalizaciones del mes: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @Model.TotalDeductivas + Model.TotalPenalizaciones)</b>
                                        </h5>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="row col-lg-12">
                                    <div class="text-center col-lg-12 h5">
                                        <b class="text-success">No se presentaron deductivas y penalizaciones en el mes de evaluación.</b>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (pr.Abreviacion.Equals("HistorialCedula"))
                {
                    <div class="tab-pane fade" id="HistorialCedula" role="tabpanel" aria-labelledby="contact-tab">
                        <div class="row justify-content-center align-items-center mt-4">
                            <div class="col-lg-12 h3 ml-4">
                                Seguimiento de la Cédula
                            </div>
                            <div class="row col-lg-12">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Servicio</th>
                                            <th>Usuario</th>
                                            <th>Comentarios</th>
                                            <th>Estatus</th>
                                            <th>Fecha de Actualización</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var hist in @Model.historialCedulas)
                                        {
                                            <tr>
                                                <td>@hist.Servicio</td>
                                                <td>@hist.usuarios.nombre_emp @hist.usuarios.paterno_emp @hist.usuarios.materno_emp</td>
                                                <td>@hist.Comentarios</td>
                                                <td>@hist.Estatus</td>
                                                <td>@Convert.ToDateTime(@hist.FechaCreacion).ToString("dd/MM/yyyy hh:mm tt")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else if (pr.Abreviacion.Equals("HistorialEntregables"))
                {
                    <div class="tab-pane fade" id="HistorialEntregables" role="tabpanel" aria-labelledby="contact-tab">
                        <div class="row justify-content-center align-items-center mt-4">
                            <div class="col-lg-12 h3 ml-4">
                                Seguimiento de Entregables
                            </div>
                            <div class="row col-lg-12">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Servicio</th>
                                            <th>Usuario</th>
                                            <th>Comentarios</th>
                                            <th>Estatus</th>
                                            <th>Fecha de Actualización</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var hist in @Model.historialEntregables)
                                        {
                                            <tr>
                                                <td>@hist.Servicio</td>
                                                <td>@hist.usuarios.nombre_emp @hist.usuarios.paterno_emp @hist.usuarios.materno_emp</td>
                                                <td>@hist.Comentarios</td>
                                                <td>@hist.Estatus</td>
                                                <td>@Convert.ToDateTime(@hist.FechaCreacion).ToString("dd/MM/yyyy hh:mm tt")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="tab-pane fade" id="@pr.Abreviacion.Replace(" ","")" role="tabpanel" aria-labelledby="profile-tab">
                        <div class="col-lg-12 h3 mt-4">
                            @pr.Valor
                        </div>
                        @foreach (var res in Model.RespuestasEncuesta)
                        {
                            @if (@res.Pregunta == pr.NoPregunta)
                            {
                                <div class="row mt-4">
                                    <div class="row col-lg-12 mt-3">
                                        <div class="col-lg-12 mt-4">
                                            @if (@res.Respuesta == false)
                                            {
                                                @if (pr.Cierre)
                                                {
                                                    <p class="h3 text-justify text-success ml-2">La fecha de cierre fue el @Convert.ToDateTime(res.Detalles).ToString("dd/MM/yyyy")</p>
                                                }
                                                else if (pr.Incidencias)
                                                {
                                                    i = 0;
                                                    tp = 0;
                                                    if (res.Pregunta == 1 || res.Pregunta == 2)
                                                    {
                                                        <p class="h3 text-justify text-danger ml-2">El prestador de servicios presentó incidencias de <strong>@pr.Valor</strong>, siendo acreedor a una penalización.</p>
                                                        <div class="col-lg-12 mt-3 ml-2">
                                                            <table class="table tableIncidencias" width="100%">
                                                                <thead>
                                                                    <tr>
                                                                        <th>ID</th>
                                                                        <th>Tipo</th>
                                                                        <th>Fecha Programada</th>
                                                                        <th>Fecha Efectiva</th>
                                                                        <th>Numero Guía</th>
                                                                        <th>Codigo Rastreo</th>
                                                                        <th>Tipo de Servicio</th>
                                                                        <th>¿Acuse?</th>
                                                                        <th>Sobrepeso (Kg)</th>
                                                                        <th>Penalización</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="tIncidenciasEquipo">
                                                                    @foreach (var inc in Model.incidencias.mensajeria)
                                                                    {
                                                                        if (inc.Pregunta == res.Pregunta)
                                                                        {
                                                                            i++;
                                                                            <tr>
                                                                                <td>@i</td>
                                                                                <td>@inc.Tipo</td>
                                                                                <td>@inc.FechaProgramada.ToString("dd/MM/yyyy")</td>
                                                                                <td>@inc.FechaEfectiva.ToString("dd/MM/yyyy")</td>
                                                                                <td>@inc.NumeroGuia</td>
                                                                                <td>@inc.CodigoRastreo</td>
                                                                                <td>@inc.TipoServicio</td>
                                                                                <td>@inc.Acuse</td>
                                                                                @if (inc.Sobrepeso != 0)
                                                                                {
                                                                                    <td>@inc.Sobrepeso</td>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <td>@inc.Sobrepeso.ToString("N2") (Kg)</td>
                                                                                }
                                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", inc.MontoPenalizacion)</td>
                                                                            </tr>
                                                                        }
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    }
                                                    else if (res.Pregunta == 3)
                                                    {
                                                        if (res.Detalles.Equals("N/A"))
                                                        {
                                                            <div class="row col-lg-12 mt-3">
                                                                <div class="col-lg-9 mt-3 ml-4">
                                                                    <p class="h3 text-justify text-success">La entrega de acuses semanales no aplica en el mes de evaluación.</p>
                                                                </div>
                                                                <div class="col-lg-2" style="margin-top: -18px;">
                                                                    <div class="small-box bg-warning">
                                                                        <div class="icon">
                                                                            <i class="fas fa-check-circle text-success"></i>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <p class="h3 text-justify text-danger ml-2">El prestador de servicios presentó incidencias de <strong>@pr.Valor</strong>, siendo acreedor a una penalización.</p>
                                                            <div class="col-lg-12 mt-3 ml-2">
                                                                <table class="table tableIncidencias" width="100%">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>ID</th>
                                                                            <th>Tipo</th>
                                                                            <th>Fecha Programada</th>
                                                                            <th>Fecha Efectiva</th>
                                                                            <th>Total Acuses</th>
                                                                            <th>Penalización</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="tIncidenciasEquipo">
                                                                        @foreach (var inc in Model.incidencias.mensajeria)
                                                                        {
                                                                            if (inc.Pregunta == res.Pregunta)
                                                                            {
                                                                                i++;
                                                                                <tr>
                                                                                    <td>@i</td>
                                                                                    <td>@inc.Tipo</td>
                                                                                    <td>@inc.FechaProgramada.ToString("dd/MM/yyyy")</td>
                                                                                    <td>@inc.FechaEfectiva.ToString("dd/MM/yyyy")</td>
                                                                                    <td>@inc.TotalAcuses</td>
                                                                                    <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", inc.MontoPenalizacion)</td>
                                                                                </tr>
                                                                            }
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <p class="h3 text-justify text-success ml-2 mt-3">El prestador de servicios no presentó incidencias en el mes evaluado.</p>
                                                    }
                                                }
                                                else if (pr.Numero)
                                                {
                                                    <p class="h3 text-justify text-danger ml-2 mt-3">El prestador de servicios no entregó material suficiente de embalaje en el mes evaluado.</p>
                                                }
                                                else
                                                {
                                                    <p class="h3 text-justify text-danger ml-2">El prestador de servicios no cumplió con el rubro @pr.Valor</p>
                                                }
                                            }
                                            else if (@res.Respuesta == true)
                                            {
                                                if (pr.Incidencias)
                                                {
                                                    i = 0;
                                                    tp = 0;
                                                    if (res.Pregunta == 4 || res.Pregunta == 5 || res.Pregunta == 6)
                                                    {
                                                        <p class="h3 text-justify text-danger ml-2">El prestador de servicios presentó incidencias de <strong>@pr.Valor</strong>, siendo acreedor a una penalización.</p>
                                                        <div class="col-lg-12 mt-3 ml-2">
                                                            <table class="table tableIncidencias" width="100%">
                                                                <thead>
                                                                    <tr>
                                                                        <th>ID</th>
                                                                        <th>Tipo</th>
                                                                        <th>Numero Guía</th>
                                                                        <th>Codigo Rastreo</th>
                                                                        <th>Tipo de Servicio</th>
                                                                        <th>Sobrepeso(Kg)</th>
                                                                        <th>Acta de Extravío</th>
                                                                        <th>Penalización</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="tIncidenciasEquipo">
                                                                    @foreach (var inc in Model.incidencias.mensajeria)
                                                                    {
                                                                        if (inc.Pregunta == res.Pregunta)
                                                                        {
                                                                            i++;
                                                                            <tr>
                                                                                <td>@i</td>
                                                                                <td>@inc.Tipo</td>
                                                                                <td>@inc.NumeroGuia</td>
                                                                                <td>@inc.CodigoRastreo</td>
                                                                                <td>@inc.TipoServicio</td>
                                                                                @if (inc.Sobrepeso != 0)
                                                                                {
                                                                                    <td>@inc.Sobrepeso</td>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <td>@inc.Sobrepeso.ToString("N2") (Kg)</td>
                                                                                }
                                                                                @if (inc.Pregunta == 6)
                                                                                {
                                                                                    <td>
                                                                                        <a href="#" class="view_actaRobo" data-toggle="tooltip" title='Ver el Acta de Robo' data-placement="top" data-tipo="@inc.TipoServicio"
                                                                                           data-guia="@inc.NumeroGuia" data-codigo="@inc.CodigoRastreo" data-file="@inc.NombreActa">
                                                                                            <i class="fad fa-eye text-success mr-2"></i>
                                                                                        </a>
                                                                                    </td>
                                                                                }
                                                                                else if (inc.Pregunta == 5)
                                                                                {
                                                                                    <td>
                                                                                        <a href="#" class="view_actaExtravio" data-toggle="tooltip" title='Ver el Acta de Robo' data-placement="top" data-tipo="@inc.TipoServicio"
                                                                                           data-guia="@inc.NumeroGuia" data-codigo="@inc.CodigoRastreo" data-file="@inc.NombreActa">
                                                                                            <i class="fad fa-eye text-success mr-2"></i>
                                                                                        </a>
                                                                                    </td>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <td>N/A</td>
                                                                                }
                                                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", inc.MontoPenalizacion)</td>
                                                                            </tr>
                                                                        }
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <p class="h3 text-justify text-success ml-2 mt-3">El prestador de servicios no presentó incidencias en el mes evaluado.</p>
                                                    }
                                                }
                                                else if (pr.Numero)
                                                {
                                                    <p class="h3 text-justify text-success ml-2 mt-3">El prestador de servicios entregó suficiente material de embalaje en el mes evaluado.</p>
                                                }
                                                else
                                                {
                                                    <p class="h3 text-justify text-success ml-2 mt-3">El prestador de servicios cumplió con el rubro "@pr.Valor" en el mes evaluado.</p>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>

@* Modal para la ver Adjuntos *@
<div class="modal fade" id="show_pdf">
    <div class="modal-dialog modal-xl-view">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titlePDF"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body-view">
                <table class="table">
                    <tr>
                        <td><strong>Folio: </strong> @Model.Folio</td>
                        <td><strong>Año: </strong>@Model.Anio</td>
                        <td><strong>Mes: </strong>@Model.Mes</td>
                        <td><strong>Inmueble: </strong>@Model.inmuebles.Nombre</td>
                        <td><strong>Estatus: </strong>@Model.Estatus </td>
                    </tr>
                </table>
                <div class="row" id="objectPdf">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver Adjuntos*@

@* Modal para la ver Adjuntos *@
<div class="modal fade" id="modal_pdf">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titlePDF"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <tr>
                        <td id="view_folio"><strong>Folio de la Cédula: </strong>@Model.Folio</td>
                        <td id="view_guia"></td>
                        <td id="view_codigoRastreo"></td>
                        <td id="view_tipoServicio"></td>
                    </tr>
                </table>
                <div class="row" id="actaRoboPDF"></div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver Adjuntos*@

@section Scripts{
    <script>
        $(function () {
            var model = @Html.Raw(Json.Serialize(@Model));
            $('[data-toggle="tooltip"]').tooltip();

            if (localStorage.getItem('activeTab')) {
                var idTab = localStorage.getItem('activeTab').replace("#", "");
                $('a[href="#InformacionGeneral"]').removeClass('active');
                $('a[href="' + localStorage.getItem('activeTab') + '"]').addClass('active');
                $("#InformacionGeneral").removeClass("show active");
                $("#" + idTab).addClass("show active");
            } else {
                $('#myTab li:first').addClass('active');
            }

            $('[data-toggle="tooltip"]').tooltip();
            $(".conceptosFactura").css("display", "none");

            /*Ver archivo en modal*/
            $(document).on('click', '.view_file', function () {
                let nombre = $(this).data('file');
                let tipo = $(this).data('tipo');
                let data = "<object width='100%' height='710px' data='/view/entregable/" + model.folio + "/" + nombre + "'></object>";
                $('#titlePDF').text("PDF - \"" + tipo + "\"");
                $('#objectPdf').html(data);
                $('#show_pdf').modal('show');
            });
            /*FIN de ver archivo en modal*/

            /*Ver el acta de robo (REVISAR PARA AJUSTAR)*/
                 $(document).on('click', '.view_actaRobo', function () {
                    let nombre = $(this).data('file');
                    let guia = $(this).data('guia');
                    let codigo = $(this).data('codigo');
                    let tipo = $(this).data('tipo');
                    let url = '<object class="objectPdf" width="100%" height="450" embedded=True data="' + '/view/actadeRobo/' + model.folio + '/' + nombre + '"></object>';
                     $('#titlePDFActas').text("Acta de Robo");
                    $('#view_guia').html("<strong>Número de Guía: </strong>" + guia);
                    $('#view_codigoRastreo').html("<strong>Código de Rastreo: </strong>" + codigo);
                    $('#view_tipoServicio').html("<strong>Tipo de Servicio: </strong>" + tipo);
                    $('#actaRoboPDF').html(url);
                    $('#modal_acta').modal('show');
                });
            /*FIN de ver el acta de robo */

            /*Ver el acta de robo (REVISAR PARA AJUSTAR)*/
                $(document).on('click', '.view_actaExtravio', function () {
                    let nombre = $(this).data('file');
                    let guia = $(this).data('guia');
                    let codigo = $(this).data('codigo');
                    let tipo = $(this).data('tipo');
                    let url = '<object class="objectPdf" width="100%" height="450" embedded=True data="' + '/view/actaExtravio/' + model.folio + '/' + nombre + '"></object>';
                    $('#titlePDFActas').text("Acta de Extravío");
                    $('#view_guia').html("<strong>Número de Guía: </strong>" + guia);
                    $('#view_codigoRastreo').html("<strong>Código de Rastreo: </strong>" + codigo);
                    $('#view_tipoServicio').html("<strong>Tipo de Servicio: </strong>" + tipo);
                    $('#actaRoboPDF').html(url);
                    $('#modal_acta').modal('show');
                });
            /*FIN de ver el acta de robo */

            /*Autorizar Cedula*/
            $(document).on('click', '.success_cedula', function () {
                if (model.usuarios.correo_electronico == "") {
                    Swal.fire({
                        'icon': 'error',
                        'title': 'Servicio de Mensajería Acelerada',
                        'text': 'No se puede "Aceptar" la cédula ya que aún no se registra un correo electrónico para notificarle al usuario.'
                    });
                } else {
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Servicio de Mensajería Acelerada',
                        'html': '¿Esta seguro de que desea <b>Aceptar la cédula con el folio: ' + model.folio + ' ?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, aceptar cédula',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            Swal.fire({
                                icon: 'info',
                                title: 'Servicio de Mensajería Acelerada',
                                text: 'Por favor capture el motivo por el cual autoriza la cédula.',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                cancelButtonText: 'Cancelar',
                                confirmButtonText: 'Autorizar',
                                input: 'textarea',
                                inputPlaceholder: 'Escriba los comentarios correspondientes'
                            }).then(send => {
                                if (send.value.length > 0) {
                                    axios.post('/mensajeria/historialMensajeria', {
                                        ServicioId: model.servicioId,
                                        CedulaId: model.id, UsuarioId: parseInt(@User.Claims.ElementAt(0).Value),
                                        Estatus: "Autorizada", Comentarios: send.value
                                    }).then(hist => {
                                        if (hist.status == 200) {
                                            axios.post('/mensajeria/aprovRechCed', { Id: model.id, Estatus: "Autorizada" }).then(response => {
                                                if (response.status == 200) {
                                                    Swal.fire({
                                                        icon: "info",
                                                        allowOutsideClick: false,
                                                        'title': 'Servicio de Mensajería Acelerada',
                                                        html: "Autorizando la cédula, por favor espere."
                                                    });
                                                    Swal.showLoading();
                                                    axios.get('/cedula/notificacionCedula/' + model.id).then(notificacion => {
                                                        if (notificacion.status == 200) {
                                                            Swal.hideLoading();
                                                            Swal.fire({
                                                                icon: "success",
                                                                'title': 'Servicio de Mensajería Acelerada',
                                                                html: "Se autorizó la cédula de evaluación correctamente.",
                                                            }).then(function () {
                                                                window.location.reload();
                                                            });
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    }).catch(er => {
                                        Swal.fire({
                                            'icon': 'error',
                                            title: 'Servicio de Mensajería Acelerada',
                                            'text': 'Ocurrio un error al autorizar la cédula. Contacte al Administrador de Sistema.'
                                        });
                                    });
                                } else {
                                    Swal.fire({
                                        'icon': 'error',
                                        title: 'Servicio de Mensajería Acelerada',
                                        'text': 'Es necesario capturar los comentarios indicando el motivo por el cual se rechaza la cédula.'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            /*Fin de Autorizar Cedula*/

            /*Rechazar Cedula*/
            $(document).on('click', '.failed_cedula', function () {
                if (model.usuarios.correo_electronico == "") {
                    Swal.fire({
                        'icon': 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'text': 'No se puede "Rechazar" la cédula ya que aún no se registra un correo electrónico para notificarle al usuario.'
                    })
                } else {
                    Swal.fire({
                        'icon': 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        'html': '¿Esta seguro de que desea <b>Rechazar la cédula con el folio: ' + model.folio + ' ?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, rechazar cédula',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            Swal.fire({
                                icon: 'info',
                                title: 'Servicio de Mensajería Acelerada',
                                text: 'Por favor capture el motivo por el cual rechaza la cédula.',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                cancelButtonText: 'Cancelar',
                                confirmButtonText: 'Rechazar',
                                input: 'textarea',
                                inputPlaceholder: 'Escribe los comentarios correspondientes'
                            }).then(send => {
                                if (send.value.length > 0) {
                                    axios.post('/mensajeria/historialMensajeria', {
                                        ServicioId: model.servicioId,
                                        CedulaId: model.id, UsuarioId: parseInt(@User.Claims.ElementAt(0).Value),
                                        Estatus: "Rechazada", Comentarios: send.value
                                    }).then(hist => {
                                        if (hist.status == 200) {
                                            axios.post('/mensajeria/aprovRechCed', { Id: model.id, Estatus: "Rechazada" }).then(response => {
                                                if (response.status == 200) {
                                                    Swal.fire({
                                                        icon: "info",
                                                        allowOutsideClick: false,
                                                        'title': 'Servicio de Mensajería Acelerada',
                                                        html: "Rechazando la cédula, por favor espere."
                                                    });
                                                    Swal.showLoading();
                                                    axios.get('/cedula/notificacionCedula/' + model.id).then(notificacion => {
                                                        if (notificacion.status == 200) {
                                                            Swal.hideLoading();
                                                            Swal.fire({
                                                                icon: "success",
                                                                'title': 'Servicio de Mensajería Acelerada',
                                                                html: "Se rechazó la cédula de evaluación correctamente.",
                                                            }).then(function () {
                                                                window.location.reload();
                                                            });
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    }).catch(er => {
                                        Swal.fire({
                                            'icon': 'error',
                                            title: 'Servicio de Mensajería Acelerada',
                                            'text': 'Ocurrio un error al rechazar la cédula. Contacte al Administrador del Sistema.'
                                        });
                                    });
                                } else {
                                    Swal.fire({
                                        'icon': 'error',
                                        title: 'Servicio de Mensajería Acelerada',
                                        'text': 'Capture los comentarios indicando el motivo por el cual se rechaza la cédula.'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            /*Fin de Rechazar Cedula*/

            $('.tableIncidencias').DataTable({
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        title: 'Servicio de Mensajería Acelerada - Listado de Incidencias',
                        className: "bg-cjf mr-1",
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Servicio de Mensajería Acelerada - Listado de Incidencias',
                        className: "bg-cjf mr-1"
                    },
                    {
                        extend: 'print',
                        title: 'Servicio de Mensajería Acelerada - Listado de Incidencias',
                        text: 'Imprimir',
                        className: "bg-cjf mr-1"
                    },
                    /*{
                        extend: 'colvis',
                        text: 'Ocultar Columnas',
                        className: "bg-cjf"
                    }*/],
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                autoWidth: false,
                responsive: true,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

             /****************************************** Facturación Cedula *********************************************/
                /*Ver/Ocultar Conceptos de Factura*/
                    $('.viewConceptosF').click(function () {
                        let factura = $(this).data('factura');
                        if ($("#conceptoFactura_" + factura).css('display') == 'none')
                        {
                            $("#conceptoFactura_" + factura).css("display", "block");
                        }
                        else
                        {
                            $("#conceptoFactura_" + factura).css("display", "none");
                        }
                    });
                /*Fin Ver/Ocultar Conceptos de Factura*/

                /*Ver/Ocultar Conceptos*/
                     $(".viewConceptosF").click(function () {
                         if ($("#viewConceptos_"+$(this).data('factura')+" > i").hasClass("text-success")) {
                             $("#viewConceptos_" + $(this).data('factura') + " > i").removeClass("text-success");
                             $("#viewConceptos_" + $(this).data('factura') + "> i").addClass("text-danger");
                         } else {
                             $("#viewConceptos_" + $(this).data('factura') +" > i").removeClass("text-danger");
                             $("#viewConceptos_"+$(this).data('factura')+" > i").addClass("text-success");
                        }
                    });
                /*Fin de Ver/Ocultar Conceptos*/
            /****************************************** Fin Facturación Cedula *****************************************/


            /************** Actualizar Correo Electrónico **********************/
                $("#btn_correo").click(function () {
                    var email = model.usuarios.correo_electronico;
                    $("#user_email").val(email);
                    $("#modal-email").modal("show");
                });

                $("#update_email").click(function () {
                    var email = $("#user_email").val();
                    var user = model.usuarios.id;

                    if(email.indexOf('@String.Format("@")', 0) == -1 || email.indexOf('.', 0) == -1) {
                        Swal.fire({
                            'icon': 'warning',
                            'title': 'Actualización de Correo Electrónico',
                            'html': 'El correo electrónico capturado no es válido. Favor de revisar.'
                        });
                        return false;
                    }

                    axios.post('/usuarios/actualizaEmail', { Id: user, correo_electronico: email }).then(res => {
                        Swal.fire({
                            'icon': 'success',
                            'title': 'Actualización de Correo Electrónico',
                            'html': 'Se actualizó la dirección de correo electrónico del usuario.'
                        }).then(function () {
                            window.location.reload();
                        });
                    });

                });
            /************ Fin Actualizar Correo Electrónico ********************/

            /*Ver archivo en modal (REVISAR PARA AJUSTAR)*/
            $(document).on('click', '.view_actaRobo', function () {
                let nombre = $(this).data('file');
                let guia = $(this).data('guia');
                let codigo = $(this).data('codigo');
                let tipo = $(this).data('tipo');
                let url = '<object class="objectPdf" width="100%" height="450" embedded=True data="' + '/view/actadeRobo/' + model.folio + '/' + nombre + '"></object>';
                $('#titlePDF').text("Acta de Robo");
                $('#view_guia').html("<strong>Número de Guía: </strong>" + guia);
                $('#view_codigoRastreo').html("<strong>Código de Rastreo: </strong>" + codigo);
                $('#view_tipoServicio').html("<strong>Tipo de Servicio: </strong>" + tipo);
                $('#actaRoboPDF').html(url);
                $('#modal_pdf').modal('show');
            });
                /*FIN de ver archivo en modal*/
                
            /*Ver archivo en modal (REVISAR PARA AJUSTAR)*/
            $(document).on('click', '.view_actaExtravio', function () {
                let nombre = $(this).data('file');
                let guia = $(this).data('guia');
                let codigo = $(this).data('codigo');
                let tipo = $(this).data('tipo');
                let url = '<object class="objectPdf" width="100%" height="450" embedded=True data="' + '/view/actaExtravio/' + model.folio + '/' + nombre + '"></object>';
                $('#titlePDF').text("Acta de Robo");
                $('#view_guia').html("<strong>Número de Guía: </strong>" + guia);
                $('#view_codigoRastreo').html("<strong>Código de Rastreo: </strong>" + codigo);
                $('#view_tipoServicio').html("<strong>Tipo de Servicio: </strong>" + tipo);
                $('#actaRoboPDF').html(url);
                $('#modal_pdf').modal('show');
            });
                /*FIN de ver archivo en modal*/

        });
    </script>
}


