@model CedulasEvaluacion.Entities.MCatalogoServicios.ModelsCatalogo;
@{
    ViewData["Title"] = "Obligaciones del Prestador de Servicios";
    var i = 0;
    var cv = 0;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="col-lg-12">
                <a href="/catalogo/detalleServicio/@Model.servicio.Id" type='button' class="btn btn-sm btn-warning float-right"
                   data-toggle="tooltip" title="Regresar al Listado de Servicios" data-placement="top">
                    <i class="fal fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-3 text-center mt-3">
                            <img src="~/img/servicios/@String.Concat(@Model.servicio.Id, ".png")" alt="" class="img-fluid" width="100" height="100">
                        </div>
                        <div class="col-7 ml-3">
                            <h2 class="lead"><b>Servicio de @Model.servicio.Nombre</b></h2>
                            <p class="text-muted text-sm"><b>Contrato actual: </b> @Model.contrato.NumeroContrato </p>
                            <p class="text-muted text-sm">
                                <b>Vigencia: </b> Del @Model.contrato.FechaInicio.ToString("dd") de @Model.contrato.FechaInicio.ToString("MMMM", @System.Globalization.CultureInfo.CreateSpecificCulture("es"))
                                @Model.contrato.FechaInicio.ToString("yyyy") al @Model.contrato.FechaFin.ToString("dd") de @Model.contrato.FechaFin.ToString("MMMM", @System.Globalization.CultureInfo.CreateSpecificCulture("es"))
                                @Model.contrato.FechaFin.ToString("yyyy")
                            </p>
                            <p class="text-muted text-sm"><b>Prestador de Servicio: </b> @Model.contrato.Empresa </p>
                            @{ string rep = !@Model.contrato.Representante.Equals("") ? @Model.contrato.Representante : "Por Capturar"; }
                            <p class="text-muted text-sm"><b>Representante Legal: </b>@rep</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-joke text-white">
                    <h5>Obligaciones Entregadas</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="contact-tab" data-toggle="tab" href="#convenios" role="tab" aria-controls="contact" aria-selected="false">Convenios</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="contact-tab" data-toggle="tab" href="#entregables" role="tab" aria-controls="contact" aria-selected="false">Entregables</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="contact-tab" data-toggle="tab" href="#documentacion" role="tab" aria-controls="contact" aria-selected="false">Documentación del Contrato</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        @* Entregables *@
                        <div class="tab-pane mt-2 ml-3 show fade active" id="convenios" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="col-lg-12 mt-3">
                                <h3>Convenios del Contrato</h3>
                            </div>
                            <div class="row mt-3 float-right">
                                <div class="col-lg-12">
                                    <a href="#" class="btn btn-sm btn-success mr-2" id="newContrato" data-toggle="tooltip" title='Capturar Contrato'>
                                        <i class="fas fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="row col-lg-12">
                                <table class="table mt-4">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>No. Convenio</th>
                                            <th>Fecha Inicio</th>
                                            <th>Fecha Fin</th>
                                            <th>Monto Mínimo</th>
                                            <th>Monto Máximo</th>
                                            <th>Volumetria Mínima</th>
                                            <th>Volumetria Máxima</th>
                                            <th>Observaciones</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var con in Model.contrato.convenios)
                                        {
                                            cv++;
                                            <tr>
                                                <td>@cv</td>
                                                <td>@con.NoContrato</td>
                                                <td>@con.FechaInicio.ToString("dd/MM/yyyy")</td>
                                                <td>@con.FechaFin.ToString("dd/MM/yyyy")</td>
                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @con.MontoMin)</td>
                                                <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @con.MontoMax)</td>
                                                <td>@con.VolumetriaMin</td>
                                                <td>@con.VolumetriaMax</td>
                                                <td>@con.Observaciones</td>
                                                <td>
                                                    <a href="#" class="editConvenio" data-id="@con.Id" data-convenio="@con.NoContrato" data-montomin="@con.MontoMin"
                                                       data-montomax="@con.MontoMax" data-volmin="@con.VolumetriaMin" data-volmax="@con.VolumetriaMax"
                                                       data-fechai="@con.FechaInicio.ToString("yyyy-MM-dd")" data-fechaf="@con.FechaFin.ToString("yyyy-MM-dd")"
                                                       data-observaciones="@con.Observaciones">
                                                        <i class="fas fa-pencil text-primary"></i>
                                                    </a>
                                                    <a href="#" class="eliminarConvenio" data-id="@con.Id">
                                                        <i class="fad fa-times text-danger ml-2"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade mt-2 ml-3" id="entregables" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="col-lg-12 mt-3">
                                <h3>Obligaciones PS</h3>
                                Listado de obligaciones del prestador de servicios.
                                <a href="/catalogo/nuevaObligacion/@Model.contrato.Id" type='button' class='btn-sm btn-success mr-2 float-right btn_addFile'><i class="fas fa-plus"></i></a>
                            </div>
                            <div class="row col-lg-12 mt-3">
                                <table class="table" id="tblEntregables">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Tipo de Obligación</th>
                                            <th>Tipo de Contrato</th>
                                            <th>Periodo</th>
                                            <th class="text-center">Penalizable</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tEntregables">
                                        @foreach (var doc in @Model.entregables)
                                        {
                                            i++;
                                            <tr>
                                                <td>@i</td>
                                                <td>@doc.Tipo</td>
                                                <td>@doc.TipoContrato</td>
                                                <td>@doc.InicioPeriodo.ToString("dd/MM/yyyy") al @doc.FinPeriodo.ToString("dd/MM/yyyy")</td>
                                                @if (@doc.FechaProgramada < @doc.FechaEntrega && !@doc.FechaEntrega.ToString("dd/MM/yyyy").Equals("01/01/0001"))
                                                {
                                                    <td class="text-center text-danger font-weight-bold">
                                                        Si
                                                    </td>
                                                }
                                                else if (@doc.FechaProgramada >= @doc.FechaEntrega && !@doc.FechaEntrega.ToString("dd/MM/yyyy").Equals("01/01/0001"))
                                                {
                                                    <td class="text-center text-success font-weight-bold">
                                                        No
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td class="text-center text-primary font-weight-bold">
                                                        Pendiente
                                                    </td>
                                                }
                                                <td>
                                                    <a href="/catalogo/verObligacion/@doc.Id">
                                                        <i class="fad fa-eye text-success mr-2"></i>
                                                    </a>
                                                    <a href="/catalogo/editarObligacion/@doc.Id">
                                                        <i class="fad fa-pencil text-primary mr-2"></i>
                                                    </a>
                                                    <a href="/catalogo/eliminar/obligacion/@doc.Id">
                                                        <i class="fad fa-times text-danger"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane mt-2 ml-3" id="documentacion" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="col-lg-12 mt-3">
                                <h3>Documentación del Contrato</h3>
                                Documentación realizada para la adjudicación del prestador de servicios.
                            </div>
                            <div class="row col-lg-12 mt-3">
                                <table class="table table-responsive-xl mt-3">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Documentación</th>
                                            <th>Archivo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>Contrato</td>
                                            <td>@(Model.contrato.ContratoPDF.Equals("") ? "No se ha adjuntado el archivo": Model.contrato.ContratoPDF)</td>
                                            <td class="text-center">
                                                @if (Model.contrato.ContratoPDF.Equals(""))
                                                {
                                                    <a href="#" class="mr-2 attachFile" data-toggle="tooltip" title='Adjuntar Contrato'>
                                                        <i class="fas fa-paperclip text-info"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a href="#" class="mr-2 viewFile" data-toggle="tooltip" title='Ver Contrato' data-file="@Model.contrato.ContratoPDF" data-tipo="Contrato">
                                                        <i class="fas fa-eye text-success"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 editFile" data-toggle="tooltip" title='Modificar Contrato' data-file="@Model.contrato.ContratoPDF" data-tipo="ContratoPDF">
                                                        <i class="fas fa-pencil text-primary"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 deleteFile" data-toggle="tooltip" title='Eliminar Contrato' data-tipo="ContratoPDF">
                                                        <i class="fas fa-times text-danger"></i>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td>Anexos</td>
                                            <td>@(Model.contrato.Anexos.Equals("") ? "No se ha adjuntado el archivo": Model.contrato.Anexos)</td>
                                            <td class="text-center">
                                                @if (Model.contrato.Anexos.Equals(""))
                                                {
                                                    <a href="#" class="mr-2 attachFile" data-toggle="tooltip" title='Adjuntar Anexos'>
                                                        <i class="fas fa-paperclip text-info"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a href="#" class="mr-2 viewFile" data-toggle="tooltip" title='Ver Anexos'>
                                                        <i class="fas fa-eye text-success"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 editFile" data-toggle="tooltip" title='Modificar Anexos' data-file="@Model.contrato.Anexos" data-tipo="Anexos">
                                                        <i class="fas fa-pencil text-primary"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 deleteFile" data-toggle="tooltip" title='Eliminar Anexos' data-tipo="Anexos">
                                                        <i class="fas fa-times text-danger"></i>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>3</td>
                                            <td>Junta de Aclaraciones</td>
                                            <td>@(Model.contrato.JuntaAclaraciones.Equals("") ? "No se ha adjuntado el archivo": Model.contrato.JuntaAclaraciones)</td>
                                            <td class="text-center">
                                                @if (Model.contrato.JuntaAclaraciones.Equals(""))
                                                {
                                                    <a href="#" class="mr-2 attachFile" data-toggle="tooltip" title='Adjuntar Junta de Aclaraciones'>
                                                        <i class="fas fa-paperclip text-info"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a href="#" class="mr-2 viewFile" data-toggle="tooltip" title='Ver Junta de Aclaraciones'>
                                                        <i class="fas fa-eye text-success"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 editFile" data-toggle="tooltip" title='Modificiar Junta de Aclaraciones' data-file="@Model.contrato.JuntaAclaraciones" data-tipo="JuntaAclaraciones">
                                                        <i class="fas fa-pencil text-primary"></i>
                                                    </a>
                                                    <a href="#" class="mr-2 deleteFile" data-toggle="tooltip" title='Eliminar Junta de Aclaraciones' data-tipo="JuntaAclaraciones">
                                                        <i class="fas fa-times text-danger"></i>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        @* Fin de Entregables *@
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*Modal para Capturar Convenios*@
<div class="modal fade" id="modal-convenios">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Nuevo Contrato</h4>
                <button type="button" class="close close-incidencias text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row col-lg-12">
                    <input class="form-control" type="number" id="convenioId" />
                    <div class="form-row col-md-5" id="divContrato">
                        <label for="Anio">Número de Contrato: </label>
                        <input class="form-control" type="text" id="contrato" />
                        <div class="col-sm-12" id="error_contrato">
                            <small id="dateHelp" class="text-danger">
                                Capture el número de contrato
                            </small>
                        </div>
                    </div>
                </div>
                <div class="row col-lg-12 mt-2">
                    <div class="form-row col-md-3" id="divMontoContrato">
                        <label for="">Monto del Convenio:</label>
                        <input class="form-control" id="montoContratoMin" type="number" />
                        <div class="col-sm-12" id="error_montoMin">
                            <small id="dateHelp" class="text-danger">
                                Capture el monto min del convenio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divMontoContrato">
                        <label for="">Monto del Convenio:</label>
                        <input class="form-control" id="montoContratoMax" type="number" />
                        <div class="col-sm-12" id="error_montoMax">
                            <small id="dateHelp" class="text-danger">
                                Capture el monto max del convenio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divVolMin">
                        <label for="">Volumetría Mínima:</label>
                        <input class="form-control" id="volumetriaMin" type="number" />
                        <div class="col-sm-12" id="error_volMin">
                            <small id="dateHelp" class="text-danger">
                                Capture la volumetría mínima del convenio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divVolMax">
                        <label for="">Volumetría Máxima:</label>
                        <input class="form-control" id="volumetriaMax" type="number" />
                        <div class="col-sm-12" id="error_volMax">
                            <small id="dateHelp" class="text-danger">
                                Capture la volumetría mínima del convenio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divFechaInicio">
                        <label for="">Fecha de Inicio:</label>
                        <input class="form-control" type="date" id="fechaInicio" />
                        <div class="col-sm-12" id="error_fechaInicio">
                            <small id="dateHelp" class="text-danger">
                                Capture la Fecha de Inicio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divContrato">
                        <label for="">Fecha de Término:</label>
                        <input class="form-control" type="date" id="fechaFin" />
                        <div class="col-sm-12" id="error_fechaFin">
                            <small id="dateHelp" class="text-danger">
                                Capture la Fecha de Término
                            </small>
                        </div>
                    </div>
                </div>
                <div class="row col-lg-12">
                    <div class="form-row col-md-12" id="divContrato">
                        <label for="">Observaciones:</label>
                        <textarea class="form-control" type="date" id="observacionesConvenio"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="crearContrato"></button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin del Modal para Capturar Convenios*@

@* Modal para la captura de Adjuntos *@
<div class="modal fade" id="modal_documentacion">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Adjuntar/Modificar Documentación</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <input type="hidden" id="idContrato" />
                    <div class="form-group col-lg-4">
                        <label for="tipoIncidencia">Tipo de Entregable:</label>
                        <select class="form-control" id="tipo_entregable">
                            <option value="">Seleccione un documento</option>
                            <option value="ContratoPDF">Contrato</option>
                            <option value="Anexos">Anexos</option>
                            <option value="JuntaAclaraciones">Junta de Aclaraciones</option>
                        </select>
                        <div class="col-sm-12" id="error_tipoEntre">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el tipo de entregable
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar Archivo: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFile" accept=".pdf">
                            <label class="custom-file-label" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_customFile">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione él archivo correspondiente
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="adjuntarArchivo">Adjuntar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para la captura de Incidencias *@

@* Modal para la ver Adjuntos *@
<div class="modal fade" id="show_pdf">
    <div class="modal-dialog modal-xl-view">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titlePDF"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body-view">
                <div class="row" id="objectPdf">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver Adjuntos*@
@section Scripts{
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
            var model = @Html.Raw(Json.Serialize(@Model));

            /*Adjuntar Archivos*/
            $('#error_tipoEntre').css('display', 'none');
            $('#error_customFile').css('display', 'none');
            $('#error_comentariosEntre').css('display', 'none');

            $('#error_fechaInicio').css('display', 'none');
            $('#error_fechaFin').css('display', 'none');
            $('#error_montoMin').css('display', 'none');
            $('#error_montoMax').css('display', 'none');
            $('#error_volMax').css('display', 'none');
            $('#error_volMin').css('display', 'none');
            $('#error_contrato').css('display', 'none');

            $(".attachFile").click(function () {
                $("#idContrato").val(model.contrato.id);
                $("#tipo_entregable").val('');
                $(".custom-file-label").text('Seleccionar Archivo');
                $("#modal_documentacion").modal('show');
            });

            function validaCamposArchivo() {

                if ($('#tipo_entregable').val() == "" && $('#customFile').val() == "") {
                    $('#tipo_entregable').addClass('is-invalid');
                    $('#error_tipoEntre').css('display', 'block');

                    $('#customFile').addClass('is-invalid');
                    $('#error_customFile').css('display', 'block');

                    return false;
                }

                if ($('#tipo_entregable').val() == "") {
                    $('#tipo_entregable').addClass('is-invalid');
                    $('#error_tipoEntre').css('display', 'block');

                    return false;
                }

                if (($('#customFile').val() == "" && $('.custom-file-label').text() == "")) {

                    $('#customFile').addClass('is-invalid');
                    $('#error_customFile').css('display', 'block');

                    return false;
                }

                return true;
            }

            $("#customFile").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "pdf") {
                    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                } else {
                    Swal.fire({
                        'icon': 'error',
                        'title': 'Contratos del servicio de "' + model.servicio.nombre + '"',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".custom-file-label").text("Seleccionar Archivo");
                    document.getElementById('customFile').value = '';
                    if ($('#customFile').hasClass('is-valid')) {
                        $('#customFile').removeClass('is-valid');
                    }
                    $('#customFile').addClass('is-invalid');
                    $('#error_customFile').css('display', 'block');
                }

            });

            $('#tipo_entregable').change(function () {
                if ($('#tipo_entregable').val() == "") {
                    $('#tipo_entregable').addClass('is-invalid');
                    $('#error_tipoEntre').css('display', 'block');

                    return false;
                } else {
                    $('#tipo_entregable').removeClass('is-invalid');
                    $('#tipo_entregable').addClass('is-valid');
                    $('#error_tipoEntre').css('display', 'none');
                }
            });

            $('#customFile').change(function () {
                if ($('#customFile').val() == "") {
                    $('#customFile').addClass('is-invalid');
                    $('#error_customFile').css('display', 'block');

                } else {
                    var fileName = $("#customFile").val().split("\\").pop();
                    var ext = fileName.split('.').pop();
                    if (ext != "pdf") {
                        $('#customFile').addClass('is-invalid');
                        $('#error_customFile').css('display', 'block');
                    } else {
                        $('#customFile').removeClass('is-invalid');
                        $('#customFile').addClass('is-valid');
                        $('#error_customFile').css('display', 'none');
                    }
                }
            });

            $('#adjuntarArchivo').click(function () {
                var formData = new FormData();

                var file = document.getElementById('customFile').files[0];
                var id = $('#idContrato').val();
                var tipo = $('#tipo_entregable').val();

                formData.append("Id", model.contrato.id);
                if (file != null)
                    formData.append("Archivo", file);
                formData.append("Tipo", tipo);

                if (validaCamposArchivo()) {
                    axios.post('/contrato/InsertarActualizarsDocumentacion', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }

                    }).then(response => {
                        $('#cerrar_modal_sua').trigger('click');
                        /*Validamos la pregunta a la que se realizo el anexo de evidencia*/
                        if (response.status == 200) {
                            Swal.fire({
                                'icon': "success",
                                'title': 'Contrato del servicio de "' + model.servicio.nombre + '"',
                                'text': 'Se adjuntó la documentación de forma correcta.'
                            }).then(function () {
                                window.location.reload();
                            });
                            $('#customFile').removeClass('is-valid');
                            $('#comentarios_entregable').removeClass('is-valid');
                            $('#tipo_entregable').removeClass('is-valid');
                        }
                    }).catch(error => {
                        Swal.fire({
                            'icon': "error",
                            'title': 'Contrato del servicio de "' + model.servicio.nombre + '"',
                            'text': 'Se presento un error al intentar adjuntar la documentación.'
                        });
                    });
                    document.getElementById('customFile').value = '';
                    $('#file_id').val("");
                    $(".custom-file-label").text("Seleccionar Archivo");
                    $('#tipo_entregable').val('');
                    $('#comentarios_entregable').val('');
                }
            });

            $(".editFile").click(function () {
                $("#idContrato").val(model.contrato.id);
                $("#tipo_entregable").val($(this).data('tipo'));
                $(".custom-file-label").text($(this).data('file'));
                $("#modal_documentacion").modal('show');
            });

            $(document).on("click", ".deleteFile", function () {
                var formData = new FormData();

                formData.append("Id", model.contrato.id);
                formData.append("Tipo", $(this).data('tipo'));

                Swal.fire({
                    'icon': 'warning',
                    'title': 'Contrato del servicio de "' + model.servicio.nombre + '"',
                    'text': '¿Está seguro de eliminar el archivo?',
                    'confirmButtonColor': '#3085d6',
                    'cancelButtonColor': '#d33',
                    'confirmButtonText': 'Si, Eliminar Archivo',
                    'cancelButtonText': 'Cancelar',
                    'showCancelButton': true
                }).then(response => {
                    if (response.isConfirmed) {
                        axios.post("/contrato/eliminarDocumentacion", formData).then(response => {
                            if (response.status == 200) {
                                Swal.fire(
                                    'Contrato del servicio de "' + model.servicio.nombre + '"',
                                    'El archivo fue eliminado con éxito.',
                                    'success'
                                ).then(function () {
                                    window.location.reload();
                                });
                            }
                        }).catch(error => {
                            Swal.fire(
                                'Contrato del servicio de "' + model.servicio.nombre + '"',
                                'No se pudo procesar tu solicitud. Contacta a tu Administrador.',
                                'error'
                            );
                        });
                    }
                });
            });

            /*Ver archivo en modal*/
            $(document).on('click', '.viewFile', function () {
                let nombre = $(this).data('file');
                let tipo = $(this).data('tipo');
                let data = "<object width='100%' height='710px' data='/contrato/verDocumentacion/" + model.contrato.id + "/" + nombre + "'></object>";
                $('#titlePDF').text("PDF - \"" + tipo + "\"");
                $('#objectPdf').html(data);
                $('#show_pdf').modal('show');
            });
            /*FIN de ver archivo en modal*/


            /***************************Captura de Convenios********************************/
                $("#newContrato").click(function () {
                    $("#convenioId").val("");
                    $("#contrato").val("");
                    $("#fechaInicio").val("");
                    $("#fechaFin").val("");
                    $("#montoContratoMin").val(0);
                    $("#montoContratoMax").val(0);
                    $("#volumetriaMin").val(0);
                    $("#volumetriaMax").val(0);
                    $("#observacionesConvenio").val("");
                    $("#crearContrato").text("Crear Contrato");
                    $("#contratoId").val(model.contrato.id);
                    $("#modal-convenios").modal("show");
                });

                function validaCampos() {
                    var contrato = $("#contrato").val();
                    var fechaInicio = $("#fechaInicio").val();
                    var fechaFin = $("#fechaFin").val();

                    if (contrato != "" && fechaInicio != "" && fechaFin != "") {
                        return true;
                    }

                    if (contrato == "") {
                        $("#error_contrato").css('display', 'block');
                    }

                    if (fechaInicio == "") {
                        $("#error_fechaInicio").css('display', 'block');
                    }

                    if (fechaFin == "") {
                        $("#error_fechaFin").css('display', 'block');
                    }
                    
                    return false;
                }

                $("#crearContrato").click(function () {
                    var id = $("#convenioId").val();
                    var contrato = $("#contrato").val();
                    var fechaInicio = $("#fechaInicio").val();
                    var fechaFin = $("#fechaFin").val();
                    var montoMin = $("#montoContratoMin").val();
                    var montoMax = $("#montoContratoMax").val();
                    var volMin = $("#volumetriaMin").val();
                    var volMax = $("#volumetriaMax").val();
                    var observaciones = $("#observacionesConvenio").val();
                        
                    if (fechaInicio > fechaFin) {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Contratos del servicio de "' + model.servicio.nombre + '"',
                            'html': 'La fecha de inicio no puede ser mayor a la fecha de término. Favor de corregir'
                        });
                    }
                        
                    if (validaCampos()) {   
                        if (id == 0) {  
                            axios.post('/contratos/insertaConvenio', {
                                ContratoId: model.contrato.id, NoContrato: contrato, FechaInicio: fechaInicio, FechaFin: fechaFin, MontoMin: parseFloat(montoMin), MontoMax: parseFloat(montoMax),
                                VolumetriaMin: parseInt(volMin), VolumetriaMax: parseInt(volMax), Observaciones: observaciones
                            }).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Convenio del Contrato',
                                        'html': 'El convenio se creó correctamente.'
                                    }).then(function () {
                                        window.location.href = "/catalogo/detalleContrato/" + model.contrato.id;
                                    });
                                }
                            }); 
                        } else {
                            axios.post('/contratos/actualizaConvenio', { Id: parseInt(id),
                                ContratoId: model.contrato.id, NoContrato: contrato, FechaInicio: fechaInicio, FechaFin: fechaFin, MontoMin: parseFloat(montoMin),
                                MontoMax: parseFloat(montoMax), VolumetriaMin: parseInt(volMin), VolumetriaMax: parseInt(volMax), Observaciones: observaciones
                            }).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Convenio del Contrato',
                                        'html': 'El convenio se actualizó correctamente.'
                                    }).then(function () {
                                        window.location.href = "/catalogo/detalleContrato/" + model.contrato.id;
                                    });
                                }
                            });
                        }
                    }
                });

                $(".editConvenio").click(function () {
                    $("#convenioId").val($(this).data('id'));
                    $("#contrato").val($(this).data('convenio'));
                    $("#fechaInicio").val($(this).data('fechai'));
                    $("#fechaFin").val($(this).data('fechaf'));
                    $("#montoContratoMin").val($(this).data('montomin'));
                    $("#montoContratoMax").val($(this).data('montomax'));
                    $("#volumetriaMin").val($(this).data('volmin'));
                    $("#volumetriaMax").val($(this).data('volmax'));
                    $("#observacionesConvenio").val($(this).data('observaciones'));
                    $("#crearContrato").text("Actualizar Convenio");
                    $("#modal-convenios").modal("show");
                });

                $(".eliminarConvenio").click(function () {
                    var contrato = $(this).data('id');
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Convenios del servicio de "' + model.servicio.nombre + '"',
                        'text': '¿Está seguro de eliminar el convenio?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, eliminar',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(response => {
                        if (response.isConfirmed) {
                            axios.get('/contratos/eliminarContrato/' + contrato).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Convenios del servicio de "' + model.servicio.nombre + '"',
                                        'html': 'El contrato se eliminó correctamente.'
                                    }).then(function () {
                                        window.location.href = "/catalogo/detalleContrato/" + model.contrato.id;
                                    });
                                }
                            });
                        }
                    });
                });
            /*************************Fin de captura de Convenios***************************/

        });
    </script>
}   