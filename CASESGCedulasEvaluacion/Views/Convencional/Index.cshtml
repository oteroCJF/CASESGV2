@* Principal de Telefonia Convencional*@
@model CedulasEvaluacion.Entities.MCedula.ModelsIndex
@{
    var i = 0;
    var user = Convert.ToInt32((@User.Claims.ElementAt(2).Value).Contains("Evaluador"));
    //ViewData["Title"] = "Servicio de Telefonía Convencional y Servicios Adicionales";
    <div class="titulo-principal">
        <b>Listado de Cédulas del Servicio de Telefonía Convencional y Servicios Adicionales</b> <i class="fa-sharp fa-solid fa-phone mr-2"></i>
    </div>
}

<div class="col-md-10 d-flex">
    <div class="col-md-12 d-flex align-items-stretch">
        <div class="card w-100 bg-gray-light card-transport-bg">
            <div class="row no-gutters">
                <div class="col-9">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="card-subtitle mb-2"><strong>Contrato Actual:</strong></h6>
                                <h6 class="card-subtitle mb-2"><span style="color: darkblue; font-size: 1.05em;"><strong>CON/DGRM/DCS/080/2023</strong></span></h6>
                            </div>
                            <div class="col-md-6">
                                <h6 class="card-subtitle mb-2"><strong>Vigencia:</strong></h6>
                                <h6 class="card-subtitle mb-2"><span style="color: darkblue; font-size: 1.05em;"><strong>Del 01 de septiembre 2023 al 31 de agosto 2025</strong></span></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <section class="col-xl-10 connectedSortable">
            <div class="card">
                <div class="card-header text-white text-center py-3 shadow-sm" style="background-color: #24135f;">
                    <h3 class="card-title mb-0 fs-4 fw-bold text-uppercase">
                        <i class="fas fa-clipboard-list me-3 "></i> Cédulas de Evaluación
                    </h3>
                </div>
                <div class="card-body" style="font-size: 15px;">
                    <p class="mb-0">
                        <strong>NOTA:</strong> Para el estatus <strong class="text-danger">Rechazado</strong>, debes seleccionar el ícono <i class="fas fa-pencil-alt text-primary"></i> para editar el cuestionario. Luego, envíalo nuevamente a la DAS con las correcciones solicitadas para su revisión.
                    </p>
                    <table id="tblIncidencias" class="table table-hover table-striped table-bordered table-sm" width="100%">
                        <thead>
                            <tr>
                                <th class="text-center">ID</th>
                                <th class="text-center">Estatus</th>
                                <th class="text-center">Servicio</th>
                                <th class="text-center">Inmueble</th>
                                <th class="text-center">Folio</th>
                                <th class="text-center">Mes</th>
                                <th class="text-center">Año</th>
                                <th class="text-center">Calif</th>

                                @if (!(@User.Claims.ElementAt(2).Value).Contains("Evaluador"))
                                {
                                    <th>Validación OP</th>
                                }
                                <th class="text-center">Última Actualización</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.cedulas)
                            {
                                i++;
                                <tr>

                                    <td class="text-center align-middle">@i</td>
                                    <td class="@(item.Fondo.Replace("bg","text")) text-center align-middle" style="font-weight: bold">@Html.DisplayFor(modelItem => item.Estatus)</td>
                                    <td class="text-center align-middle">@Html.DisplayFor(modelItem => item.Servicio)</td>
                                    <td class="text-center align-middle">@Html.DisplayFor(modelItem => item.Nombre)</td>
                                    <td class="text-center align-middle">@Html.DisplayFor(modelItem => item.Folio)</td>
                                    <td class="text-center align-middle">@Html.DisplayFor(modelItem => item.Mes)</td>
                                    <td class="text-center align-middle">@Html.DisplayFor(modelItem => item.Anio)</td>
                                     <td class="text-center align-middle @(item.Calificacion < 8 ? "text-danger font-weight-bold" : "")">
                                        @Html.DisplayFor(modelItem => item.Calificacion)
                                    </td>
                                    @if (!(@User.Claims.ElementAt(2).Value).Contains("Evaluador") &&
                          (item.Estatus.Equals("En Trámite") || item.Estatus.Equals("Trámite de Pago") || item.Estatus.Equals("Enviada a DGPPT") || item.Estatus.Equals("Pagada")))
                                    {
                                        <td class="text-center">
                                            @if (item.MemoValidado == true)
                                            {
                                                <i class="fa-regular fa-check text-success mr-2" data-toggle="tooltip" title="Memorándum validado" data-placement="top"></i>
                                            }
                                            else
                                            {
                                                <i class="fa-regular fa-clipboard-check text-danger mr-2" data-toggle="tooltip" title="Memorándum pendiente de validar" data-placement="top"></i>
                                            }

                                            @if (item.CedulaValidada == true)
                                            {
                                                <i class="fa-regular fa-check text-success mr-2" data-toggle="tooltip" title="Cédula validada" data-placement="top"></i>
                                            }
                                            else
                                            {
                                                <i class="fa-regular fa-clipboard-check text-danger mr-2" data-toggle="tooltip" title="Cédula pendiente de validar" data-placement="top"></i>
                                            }

                                            @if (item.ActaFirmada == true)
                                            {
                                                <i class="fa-regular fa-file-check text-success" data-toggle="tooltip" title="Acta Entrega - Recepción" data-placement="top"></i>
                                            }
                                            else
                                            {
                                                <i class="fa-regular fa-file-xmark text-danger" data-toggle="tooltip" title="Acta Entrega - Recepción pendiente de validar" data-placement="top"></i>
                                            }
                                        </td>
                                    }
                                    else if (!(@User.Claims.ElementAt(2).Value).Contains("Evaluador") && !item.Estatus.Equals("En Trámite"))
                                    {
                                        @if (item.MemoValidado == true && item.CedulaValidada == true)
                                        {
                                            <td class="text-center">
                                                <i class="fa-regular fa-check text-success"></i>
                                                <i class="fa-regular fa-check text-success"></i>
                                            </td>
                                        }
                                        else
                                        {
                                            <td class="text-center">
                                                <i class="fa-regular fa-user-clock text-primary"></i>
                                            </td>
                                        }
                                    }
                                    <td class="text-center align-middle">@item.FechaActualizacion.ToString("dd/MM/yyyy hh:mm tt")</td>
                                    <td>
                                        @if (!item.Estatus.Equals("En Proceso") && !(@User.Claims.ElementAt(2).Value).Contains("Evaluador"))
                                        {
                                            <a href="#" data-id="@item.Id" class="text-center btnRevision" data-toggle="tooltip" title="Revisar Cédula" data-placement="top">
                                                <i class="fad fa-eye text-success"></i>
                                            </a>
                                        }
                                        @if (item.Estatus.Equals("Rechazada") || item.Estatus.Equals("En Proceso") || !(@User.Claims.ElementAt(2).Value).Contains("Evaluador"))
                                        {
                                            <a href="#" data-id="@item.Id" class="text-center ml-2 btnCuestionario" data-toggle="tooltip" title="Modificar Cédula" data-placement="top">
                                                <i class="fad fa-pencil text-primary"></i>
                                            </a>
                                        }
                                        @if (item.Estatus.Equals("En Proceso"))
                                        {
                                            <a href="#" class="text-center ml-2 delete_cedula" data-id="@item.Id" data-folio="@item.Folio" data-toggle="tooltip" title="Eliminar Cédula" data-placement="top">
                                                <i class="fad fa-times text-danger"></i>
                                            </a>
                                        }
                                        @if (!item.Estatus.Equals("En Proceso"))
                                        {
                                            <a href="#" data-id="@item.Id" data-estatus="@item.Estatus" data-servicio="@item.ServicioId" data-inmueble="@item.InmuebleId" class="text-center pdf ml-2 btn_pdf" data-toggle="tooltip" title="Generar Cédula" data-placement="top">
                                                @if (item.Estatus.Equals("Autorizada") || item.Estatus.Equals("En Trámite"))
                                                {
                                                    <i class="fal fa-file-pdf text-success"></i>
                                                }
                                                else @if (item.Estatus.Equals("Rechazada"))
                                           {
                                            <i class="fal fa-file-pdf text-danger"></i>
                                        }
                                        else
                                        {
                                            <i class="fal fa-file-pdf text-primary"></i>
                                        }
                                            </a>
                                        }
                                        @if (!item.Estatus.Equals("En Proceso"))
                                        {
                                            <a href="#" data-id="@item.Id" class="text-center ml-2 btnSeguimiento" data-toggle="tooltip" title="Seguimiento a la Cédula" data-placement="top">
                                                <i class="fas fa-file-import text-primary"></i>
                                            </a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="col-xl-2 connectedSortable">
            <div class="card">
                <div class="card-header text-white text-center py-3 shadow-sm" style="background-color: #24135f;">
                    FILTROS DE BÚSQUEDA
                    <button id="recargarPagina" class="btn btn-success" data-toggle="tooltip" title="Reiniciar Filtros">
                        <i class="fa-regular fa-arrows-rotate"></i>
                    </button>
                </div>
                <div class="card-body" style="font-size: 14px;">
                    <div class="row col-lg-12">
                        <div class="col-lg-12">
                            <b>Año:</b>
                            <a class="btn-sm bg-primary btnAnios float-right" data-target="#btnAnio" data-toggle="collapse">
                                <i class="fas fa-minus"></i>
                            </a>
                        </div>
                        @foreach (var an in Model.anios)
                        {
                            <div class="col-lg-12 show ml-3" id="btnAnio">
                                <label class="checkbox-inline">
                                    @if (Model.filtroAnios.Contains(an.Valor))
                                    {
                                        <input class="selectAnio" id="anio_@an.Valor" type="checkbox" data-toggle="toggle"
                                               data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                               data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                               data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Valor" checked> @an.Valor
                                        }
                                        else
                                        {
                                            <input class="selectAnio" id="anio_@an.Valor" type="checkbox" data-toggle="toggle"
                                                   data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                                   data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                                   data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Valor"> @an.Valor
                                            }
                                </label>
                            </div>
                        }
                    </div>
                    <div class="row col-lg-12 mt-2">
                        <div class="col-lg-12">
                            <b>Mes:</b>
                            <a class="btn-sm bg-primary btnMeses float-right" data-target="#btnMes" data-toggle="collapse">
                                <i class="fas fa-minus"></i>
                            </a>
                        </div>
                        @foreach (var an in Model.Meses)
                        {
                            <div class="col-lg-12 show ml-3" id="btnMes">
                                <label class="checkbox-inline float-left">
                                    @if (Model.filtroMeses.Contains(an.Mes))
                                    {
                                        <input class="selectMes" id="mes_@an.Mes" type="checkbox" data-toggle="toggle"
                                               data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                               data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                               data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Mes" checked> @an.Mes
                                        }
                                        else
                                        {
                                            <input class="selectMes" id="mes_@an.Mes" type="checkbox" data-toggle="toggle"
                                                   data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                                   data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                                   data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Mes"> @an.Mes
                                            }
                                </label>
                            </div>
                        }
                    </div>
                    <div class="row col-lg-12 mt-2">
                        <div class="col-lg-12">
                            <b>Estatus:</b>
                            <a class="btn-sm bg-primary btnEstatuss float-right" data-target="#btnEstatus" data-toggle="collapse">
                                <i class="fas fa-minus"></i>
                            </a>
                        </div>
                        @foreach (var an in Model.festatus)
                        {
                            <div class="col-lg-12 show ml-3" id="btnEstatus">
                                <label class="checkbox-inline">
                                    @if (Model.filtroEstatus.Contains(an.Estatus))
                                    {
                                        <input class="selectEstatus" type="checkbox" data-toggle="toggle"
                                               data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                               data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                               data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Estatus" checked> @an.Estatus
                                        }
                                        else
                                        {
                                            <input class="selectEstatus" type="checkbox" data-toggle="toggle"
                                                   data-on="<i class='fa fa-check' style='margin-top: -2px;'></i>"
                                                   data-off="<i class='fa fa-times' style='margin-top: -2px;'></i>" data-size="mini"
                                                   data-onstyle="success" data-offstyle="danger" data-style="ios" value="@an.Estatus"> @an.Estatus
                                            }
                                </label>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<style>
    .dataTables_filter {
        display: block;
    }

    #recargarPagina {
        cursor: pointer;
        font-size: 12px; /* Ajusta el tamaño de la fuente según tus necesidades */
        padding: 3px 6px;
        border-radius: 50px;
        transition: background-color 0.3s ease;
    }

    .titulo-principal {
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: #24135f;
        text-align: left;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        animation: fadeIn 2s ease-in-out;
        font-weight: bold;
        position: relative; /* Agrega esta línea */
        top: -20px; /* Ajusta el valor según sea necesario */
        right: -10px;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

@section Scripts{
    <script>
        $(function () {
            var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            var model = @Html.Raw(Json.Serialize(@Model));
            var idUsuario = @User.Claims.ElementAt(0).Value;
            var anios = [];
            var meses = [];
            var est = [];
            var admin = [];
            var admin2 = [];
            var inmuebles = [];

            $('[data-toggle="tooltip"]').tooltip();
            localStorage.clear();

            $(document).on("click",".btnRevision",function () {
                window.location.href = "/telConvencional/revision/" + $(this).data('id') + "?Anio=" + anios + "&Mes=" + meses
                    + "&Estatus=" + est;
            });

            $(document).on("click",".btnSeguimiento",function () {
                window.location.href = "/telConvencional/seguimiento/" + $(this).data('id') + "?Anio=" + anios + "&Mes=" + meses
                    + "&Estatus=" + est;
            });

            $(document).on("click",".btnCuestionario",function () {
                window.location.href = "/telConvencional/evaluacion/" + $(this).data('id') +"?Anio=" + anios + "&Mes=" + meses
                    + "&Estatus=" + est;
            });

            document.getElementById("recargarPagina").addEventListener("click", function () {
                location.reload();
            });

            function cuentaTramites() {
                var c = 0;
                for (var i = 0; i < model.length; i++) {
                    if (model[i].estatus == "En Trámite") {
                        return 1;
                    }
                }
            }

            $(document).on("click",'.btn_pdf',function () {
                let id = $(this).data('id');
                let servicio = $(this).data('servicio');
                let estatus = $(this).data('estatus');
                if (estatus == 'Autorizada') {
                    Swal.fire({
                        'icon': 'info',
                        'title': 'Servicio de Telefonía Convencional y Servicios Adicionales',
                        'html': '<p style="text-align: justify">La cédula de evaluación ya fue autorizada, no olvide firmarla electrónicamente y ' +
                            'posteriormente <strong>subirla en el sistema CASESGV2 en el apartado de "Seguimiento a la Cédula"</strong>, si tiene alguna duda por favor ' +
                            'comuníquese a la ext. 2574 o 2635. </p>'
                    }).then(function () {
                        window.open('/cedula/convencional/' + servicio + '/' + id, '_blank');
                    });
                } else {
                    window.open('/cedula/convencional/' + servicio + '/' + id, '_blank');
                }
            });

            /********************************** Filtros AJAX ***********************************/
                $('#tblIncidencias').DataTable({
                    dom: 'lBfrtip',
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            title: 'Servicio de Telefonía Convencional y Servicios Adicionales - Listado de Oficios Capturadas',
                            className: "btn-sm bg-cjf mr-1",
                        },
                        {
                            extend: 'pdfHtml5',
                            title: 'Servicio de Telefonía Convencional y Servicios Adicionales - Listado de Oficios Capturadas',
                            className: "btn-sm bg-cjf mr-1"
                        },
                        {
                            extend: 'print',
                            title: 'Servicio de Telefonía Convencional y Servicios Adicionales - Listado de Oficios Capturadas',
                            text: 'Imprimir',
                            className: "btn-sm bg-cjf mr-1"
                        },
                        /*{
                            extend: 'colvis',
                            text: 'Ocultar Columnas',
                            className: "bg-cjf"
                        }*/],
                    //"bFilter": false,
                    lengthMenu: [[35, 50, 100, -1], [35, 50, 100, "Todos"]],
                    responsive: true,
                    language: {
                        url: "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                    },
                });

                var table = $('#tblIncidencias').DataTable();

                $('.selectAnio').on('change', function () {
                    anios = [];
                    $(".selectAnio").each(function () {
                    var activo = $(this).parent().hasClass("off");
                    if (activo == false) {
                        anios.push($(this).val());
                    }
                });

                    var mergedVal = anios.join('|');
                    table.column(6).search(mergedVal, true).draw();
                });

                $('.selectMes').on('change', function () {
                    meses = [];
                    $(".selectMes").each(function () {
                    var activo = $(this).parent().hasClass("off");
                    if (activo == false) {
                        meses.push($(this).val());
                    }
                });
                    var mergedVal = meses.join('|');
                    table.column(5).search(mergedVal, true).draw();
                });

                $('.selectEstatus').on('change', function () {
                    est = [];
                    $(".selectEstatus").each(function () {
                    var activo = $(this).parent().hasClass("off");
                    if (activo == false) {
                        est.push($(this).val());
                    }
                });

                    var mergedVal = est.join('|').replace("&", "\\&").replace(/\s/g, "\\s");
                    table.column(1).search(mergedVal, true).draw();
                });

                $(".btnAnios").click(function () {
                    if ($(".btnAnios > i").hasClass("fas fa-plus")) {
                        $(".btnAnios > i").removeClass("fas fa-plus");
                        $(".btnAnios > i").addClass("fas fa-minus");
                    } else {
                        $(".btnAnios > i").removeClass("fas fa-minus");
                        $(".btnAnios > i").addClass("fas fa-plus");
                    }
                });

                $(".btnMeses").click(function () {
                    if ($(".btnMeses > i").hasClass("fas fa-plus")) {
                        $(".btnMeses > i").removeClass("fas fa-plus");
                        $(".btnMeses > i").addClass("fas fa-minus");
                    } else {
                        $(".btnMeses > i").removeClass("fas fa-minus");
                        $(".btnMeses > i").addClass("fas fa-plus");
                    }
                });

                $(".btnEstatuss").click(function () {
                    if ($(".btnEstatuss > i").hasClass("fas fa-plus")) {
                        $(".btnEstatuss > i").removeClass("fas fa-plus");
                        $(".btnEstatuss > i").addClass("fas fa-minus");
                    } else {
                        $(".btnEstatuss > i").removeClass("fas fa-minus");
                        $(".btnEstatuss > i").addClass("fas fa-plus");
                    }
                });

                if (model.filtroAnios != "") {
                    anios = [];
                    $(".selectAnio").each(function () {
                        var activo = $(this).parent().hasClass("off");
                        if (activo == false) {
                            anios.push($(this).val());
                        }
                    });

                    var mergedVal = anios.join('|');
                    table.column(6).search(mergedVal, true).draw();
                }

                if (model.filtroMeses!= "") {
                    meses = [];
                    $(".selectMes").each(function () {
                        var activo = $(this).parent().hasClass("off");
                        if (activo == false) {
                            meses.push($(this).val());
                        }
                    });
                    var mergedVal = meses.join('|');
                    table.column(5).search(mergedVal, true).draw();
                }

                if (model.filtroEstatus != "") {
                    est = [];
                    $(".selectEstatus").each(function () {
                        var activo = $(this).parent().hasClass("off");
                        if (activo == false) {
                            est.push($(this).val());
                        }
                    });
                    console.log(est);
                    var mergedVal = est.join('|').replace("&", "\\&").replace(/\s/g, "\\s");
                    table.column(1).search(mergedVal, true).draw();
                }
            /********************************** FIN Filtro Ajax*********************************/
        });
    </script>
}

