@model CedulasEvaluacion.Entities.MServiciosB.ServicioBasico;
@{

    ViewData["Title"] = "Nueva captura del Servicio " + Model.servicio.Nombre;
    int f = 0, cf = 0;
    int totalServicios = 0, totalServiciosNC = 0;
    decimal totalConceptos = 0, totalIVA = 0;
    decimal totalConceptosNC = 0, totalIVANC = 0;
}

<div class="container-fluid" id="limpieza">
    <a href="/basicos/index/@Model.ServicioId" type='button' class='btn-sm btn-warning float-right mr-2 mb-3' data-toggle="tooltip" title="Regresar al Listado" data-placement="top">
        <i class="fal fa-arrow-left"></i>
    </a>
    <div class="row col-lg-12 mt-2 mb-3">
        @if (Model.Id != 0)
        {
            <table class="table">
                <tr>
                    <td data-toggle="tooltip" title="Año de evaluación del servicio" data-placement="top"><strong>Año: </strong>@Model.Anio</td>
                    <td data-toggle="tooltip" title="Mes evaluado" data-placement="top"><strong>Mes: </strong>@Model.Mes</td>
                    <td data-toggle="tooltip" title="Administración/Inmueble evaluado" data-placement="top"><strong>Inmueble: </strong>@Model.inmuebles.Nombre</td>
                    <td data-toggle="tooltip" title="Estatus de la cédula del servicio de Agua para Beber" data-placement="top"><strong>Estatus: </strong>@Model.Estatus</td>
                </tr>
                <tr>
                    <td id="total_facturas" data-toggle="tooltip" title='Cantidad de facturas asignadas a el mes de "@Model.Mes" del inmueble "@Model.inmuebles.Nombre"' data-placement="top">
                        <strong>Facturas asignadas: </strong> @Model.facturas.Count
                    </td>
                    <td id="monto_facturas" data-toggle="tooltip" title="Monto total de las facturas capturadas en este folio" data-placement="top">
                        <strong>Monto Total IVA Incluido: </strong>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @Model.TotalMontoFactura)
                    </td>
                    <td colspan="2"></td>
                </tr>
            </table>
        }
    </div>
    <div class="card">
        <div class="card-header bg-joke text-white">
            <h5 class="mt-2">Nueva Factura del Servicio de @Model.servicio.Nombre</h5>
        </div>
        <div class="card-body">
            <div class="row ">
                <div class="col-lg-12">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Información General</a>
                        </li>
                        @if (Model.Id != 0)
                        {
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#facturacion" role="tab" aria-controls="contact" aria-selected="false">Facturación</a>
                            </li>
                        }
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="contact-tab" data-toggle="tab" href="#entregables" role="tab" aria-controls="contact" aria-selected="false">Entregables</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade mt-2 ml-3 show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                            <div class="row col-lg-12">
                                <input type="hidden" id="facturaId" />
                                <div class="col-lg-2">
                                    <label for="">Año:</label>
                                    <select class="form-control" asp-for="@Model.Anio" id="select_anio" required>
                                        <option value="">Seleccione el Año</option>
                                        @for (var i = 2022; i <= DateTime.Now.Year; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                                <div class=" col-lg-3">
                                    <label for="">Mes Correspondiente:</label>
                                    <select class="form-control" asp-for="@Model.Mes" id="select_mes" required disabled="true"></select>
                                </div>
                                <div class=" col-lg-3">
                                    <label for="">Inmueble:</label>
                                    <select class="form-control" asp-for="@Model.InmuebleId" id="select_inmueble" required disabled="true"></select>
                                </div>
                            </div>
                        </div>
                        @if (Model.Id != 0)
                        {
                            <div class="tab-pane fade mt-2 ml-3" id="facturacion" role="tabpanel" aria-labelledby="profile-tab">
                                <div class="col-lg-12 h3 mt-4">
                                    Facturación del Servicio
                                </div>
                                <div class="row col-lg-12 d-flex justify-content-end">
                                    <button class='btn btn-sm btn-primary ml-2 mb-3' data-toggle="tooltip" title="Agregar Facturas" data-placement="top" id="add_facturas">
                                        <i class="fal fa-plus text-white"></i> Agregar Factura
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="row col-lg-12">
                                        <p class="text-justify ml-3">
                                            <strong style="color: dodgerblue;">NOTA: </strong>Favor de revisar que los <strong style="color: dodgerblue;"> datos de la cédula </strong> resaltados en color <strong style="color: dodgerblue;">Azul </strong> coincidan con
                                            la información de la factura que fue agregada.
                                        </p>
                                        <div class="col-lg-12 mt-3 ml-2">
                                            <table class="table tblIncidencias tablaFacturas" width="100%">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Tipo</th>
                                                        <th>Empresa</th>
                                                        <th>Folio Fiscal</th>
                                                        <th>Número Factura</th>
                                                        <th>Subtotal Factura</th>
                                                        <th>IVA</th>
                                                        <th>Total</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="AA">
                                                    @foreach (var fac in Model.facturas)
                                                    {
                                                        f++;
                                                        <tr>
                                                            <td>@f</td>
                                                            <td>@(fac.Tipo.Equals("NC") ? "Nota de Crédito":fac.Tipo)</td>
                                                            <td>@fac.emisor.Nombre</td>
                                                            <td>
                                                                @fac.timbreFiscal.UUID
                                                                @if (!fac.cfdiRelacionado.UUID.Equals(""))
                                                                {
                                                                    <p>Relacionado al Folio Fiscal: @fac.cfdiRelacionado.UUID</p>
                                                                }
                                                            </td>
                                                            <td>@fac.comprobante.Folio</td>
                                                            <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.comprobante.SubTotal)</td>
                                                            <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.traslado.Importe)</td>
                                                            <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.comprobante.Total)</td>
                                                            <td class="text-center">
                                                                <a href="#" class="viewConceptosF" id="viewConceptos_@fac.Id" data-factura="@fac.Id">
                                                                    <i class="fas fa-eye text-success"></i>
                                                                </a>
                                                                <a target="_blank" href="/facturas/download/@fac.Id/@fac.Tipo" class="ml-2" data-id="@fac.Id">
                                                                    <i class='fa-solid fa-download text-danger'></i>
                                                                </a>
                                                                <a href="#" class="eliminarFactura ml-2" data-factura="@fac.Id" data-folio="@fac.comprobante.Serie@fac.comprobante.Folio" data-toggle="tooltip" title="Eliminar Nota de Crédito" data-placement="top">
                                                                    <i class="fas fa-times text-danger"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col-lg-12 mt-3 ml-2 mb-3">
                                            @foreach (var fac in Model.facturas)
                                            {
                                                <div class="conceptosFactura" id="conceptoFactura_@fac.Id">
                                                    <h3>Conceptos de la Factura con Folio: @fac.comprobante.Folio</h3>
                                                    <table id="@fac.comprobante.Folio" style="width: 90%" class="table tableConceptos mt-3 float-right">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Cantidad</th>
                                                                <th>Unidad</th>
                                                                <th>Descripción</th>
                                                                <th>Precio Unitario</th>
                                                                <th>SubTotal</th>
                                                                <th>IVA</th>
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var con in fac.concepto)
                                                            {
                                                                if (@fac.Id == con.FacturaId)
                                                                {
                                                                    cf++;
                                                                    <tr>
                                                                        <td>@cf</td>
                                                                        <td>@con.Cantidad</td>
                                                                        <td>@con.Unidad</td>
                                                                        <td>@con.Descripcion</td>
                                                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.ValorUnitario)</td>
                                                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Importe)</td>
                                                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.IVA)</td>
                                                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Importe + con.IVA)</td>
                                                                    </tr>
                                                                    @if (fac.Tipo.Equals("NC"))
                                                                    {
                                                                        totalServiciosNC = totalServiciosNC + Convert.ToInt32(con.Cantidad);
                                                                        totalConceptosNC = totalConceptosNC + con.Importe;
                                                                        totalIVANC = totalIVANC + Convert.ToDecimal(con.IVA.ToString("N2"));
                                                                    }
                                                                    else
                                                                    {
                                                                        totalServicios = totalServicios + Convert.ToInt32(con.Cantidad);
                                                                        totalConceptos = totalConceptos + con.Importe;
                                                                        totalIVA = totalIVA + Convert.ToDecimal(con.IVA.ToString("N2"));
                                                                    }
                                                                }
                                                            }
                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                @if (fac.Tipo.Equals("NC"))
                                                                {
                                                                    <th>Total:</th>
                                                                    <th>@totalServiciosNC - Servicios</th>
                                                                    <th colspan="3"></th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalConceptosNC)</th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalIVANC)</th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", (totalConceptosNC + totalIVANC))</th>
                                                                }
                                                                else
                                                                {
                                                                    <th>Total:</th>
                                                                    <th>@totalServicios - Servicios</th>
                                                                    <th colspan="3"></th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalConceptos)</th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", totalIVA)</th>
                                                                    <th>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", (totalConceptos + totalIVA))</th>
                                                                }
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="tab-pane fade mt-2 ml-3" id="entregables" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="col-lg-12 mt-3">
                                <h3>Adjuntar Entregables</h3>
                                <a href="#" type='button' class='btn-sm btn-success mr-2 float-right btn_addFile'><i class="fas fa-plus"></i></a>
                            </div>
                            <div class="row col-lg-12 mt-3">
                                <table class="table" id="tblEntregables">
                                    <thead>
                                        <tr>
                                            <th>Entregable</th>
                                            <th>Archivo</th>
                                            <th>Fecha de Carga</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tEntregables"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class=" col-lg-12">
                <a href="/basicos/index/@Model.ServicioId" class="btn btn-danger float-right ml-2">Cancelar</a>
                <button class="btn btn-success float-right" id="guardaServicio">Guardar</button>
                @if (Model.Id != 0)
                {
                    <button class="btn btn-primary float-right mr-2" id="enviarServicio">Enviar</button>
                }
            </div>
        </div>
    </div>
</div>

@* Modal para ver los conceptos de las facturas de la cedula *@
<div class="modal fade" id="modal-facturas">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Agregar/Modificar Factura</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input class="form-control" id="idFactura" type="hidden" />
                <div class="row col-lg-12 mt-2">
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar factura en XML: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input file_factura" id="fileFactura" accept=".xml">
                            <label class="custom-file-label" for="customFile">Subir factura en formato "XML"</label>
                        </div>
                        <div class="col-sm-12 error_customFile">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el archivo correspondiente
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="agregarFactura">Guardar Factura</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal-dialog -->
@* Fin de Modal para ver los conceptos de las facturas de la cedula *@

@* Modal para la captura de Adjuntos *@
<div class="modal fade" id="modal_evidencias">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Adjuntar Entregables</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <input type="hidden" id="file_id" />
                    <div class="form-group col-lg-4">
                        <label for="tipoIncidencia">Tipo de Entregable:</label>
                        <select class="form-control" id="tipo_entregable">
                            <option value="">Seleccione el entregable</option>
                            <option value="Factura">Factura</option>
                            <option value="SAT">Validación del SAT</option>
                        </select>
                        <div class="col-sm-12" id="error_tipoEntre">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el tipo de entregable
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar Archivo: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFile" accept=".pdf">
                            <label class="custom-file-label" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_customFile">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el archivo correspondiente
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-lg-12 mt-2" id="comentariosEntregable">
                        <div class="form-group mt-2 col-md-12">
                            <label for="fechaCierre">Comentarios:</label><br>
                            <textarea id="comentarios_entregable" class="form-control float-left"></textarea>
                            <div class="col-sm-12" id="error_comentariosEntre">
                                <small id="comentariosHelp" class="text-danger">
                                    Por favor capture los comentarios correspondientes
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="adjuntarArchivo">Adjuntar Entregable</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para la captura de Adjuntos *@

@* Modal para la ver Adjuntos *@
<div class="modal fade" id="show_pdf">
    <div class="modal-dialog modal-xl-view">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titlePDF"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body-view">
                <table class="table">
                    <tr>
                        <td><strong>Año: </strong>@Model.Anio</td>
                        <td><strong>Mes: </strong>@Model.Mes</td>
                        <td><strong>Estatus: </strong>@Model.Estatus </td>
                    </tr>
                </table>
                <div class="row" id="objectPdf">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver Adjuntos*@

@section Scripts{
    <script>
        window.onload = function () {
            var model = @Html.Raw(Json.Serialize(@Model));
            var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            $('.error_tipoFactura').css('display', 'none');
            $('.error_customFile').css('display', 'none');
            $(".conceptosFactura").css("display", "none");

            /***********Llenamos el Combo de inmuebles*****************/
                let optionsInmueble = "<option value=''>Seleccione el Inmueble</option>";
                $('#select_inmueble').prop("disabled", false);
                axios.get('/inmuebles/evaluar').then(response => {
                    response = response.data;
                    response.forEach(function (inm) {
                        optionsInmueble += "<option value=" + inm.id + ">" + inm.nombre + "</option>"
                    });
                    $("#select_inmueble").html(optionsInmueble);
                    if (model.inmuebleId != 0) {
                        $('#select_inmueble').val(model.inmuebleId);
                    }
                });
            /************ Fin del Combo de inmuebles ******************/

            /************* Llenamos el Combo de inmuebles *************/
                let optionsMes = "<option value=''>Seleccione el Mes</option>";
                $('#select_mes').prop("disabled", false);
                meses.forEach(function (mes) {
                    optionsMes += "<option value=" + mes + ">" + mes + "</option>"
                });
                $("#select_mes").html(optionsMes);
            /*********** Fin del llenado del combo inmuebles *********/

            /**************** Validación/Guardado al generar el folio ******************/
            $('#guardaServicio').click(function () {
                var isContinue = validaFormulario();
                var url = "inserta";
                var msg = "guardaron";
                var formP = new FormData();

                var inmueble = $('#select_inmueble').val();
                var anio = $('#select_anio').val();
                var mes = $('#select_mes').val();

                formP.append("UsuarioId", parseInt(@User.Claims.ElementAt(0).Value));
                formP.append("InmuebleId", parseInt(inmueble));
                formP.append("Anio", parseInt(anio));
                formP.append("Mes", mes);
                formP.append("ServicioId", model.servicio.id);

                if (model.id != 0) {
                    url = "actualiza";
                    msg = "actualizaron";
                    formP.append("Id", model.id);
                }

                //return false;
                if (isContinue == true) {
                    axios.post('/basicos/' + url + 'ServicioB', formP).then(response => {
                        Swal.fire({
                            'icon': 'success',
                            'title': 'Servicio de ' + model.servicio.nombre,
                            'text': 'Se '+msg+' los datos del servicio de ' + model.servicio.nombre + ' correctamente.'
                        }).then(function () {
                            window.location.href = '/basicos/editarFacturacion/' + model.servicio.id + "/" + response.data + window.location.search;
                        });
                    }).catch(error => {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Servicio de ' + model.servicio.nombre,
                            'text': 'Error al cargar la factura del servicio de ' + model.servicio.nombre
                        });
                    });
                }
            });

            $('#enviarServicio').click(function () {
                var isContinue = validaFormulario();
                var url = "inserta";
                var formP = new FormData();

                var inmueble = $('#select_inmueble').val();
                var anio = $('#select_anio').val();
                var mes = $('#select_mes').val();

                formP.append("UsuarioId", parseInt(@User.Claims.ElementAt(0).Value));
                formP.append("InmuebleId", parseInt(inmueble));
                formP.append("Anio", parseInt(anio));
                formP.append("Mes", mes);
                formP.append("ServicioId", model.servicio.id);

                if (model.id != 0) {
                    url = "actualiza";
                    formP.append("Id", model.id);
                }

                if (model.factura.length == 0) {
                    Swal.fire({
                        'icon': 'error',
                        'title': 'Servicio de '+model.servicio.nombre,
                        'html': 'No ha registrado ninguna factura en el servicio.'
                    });
                    return false;
                }

                //return false;
                if (isContinue == true) {
                    axios.post('/basicos/enviaServicioBasico', formP).then(response => {
                        Swal.fire({
                            'icon': 'success',
                            'title': 'Servicio de ' + model.servicio.nombre,
                            'text': 'Se envió los datos del servicio de ' + model.servicio.nombre + ' correctamente.'
                        }).then(function () {
                            window.location.href = '/basicos/index/' + model.servicio.id + window.location.search;
                        });
                    }).catch(error => {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Servicio de ' + model.servicio.nombre,
                            'text': 'Error al cargar la factura del servicio de ' + model.servicio.nombre
                        });
                    });
                }
            });

            function validaFormulario() {
                var anio = $('#select_anio').val();
                var inmueble = $('#select_inmueble').val();
                var mes = $('#select_mes').val();

                if (anio == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Servicio de ' + model.servicio.nombre,
                        'html': 'Por favor seleccione el año correspondiente.'

                    });

                    return false;
                }

                if (inmueble == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Servicio de ' + model.servicio.nombre,
                        'html': 'Por favor seleccione el inmueble correspondiente.'
                    });

                    return false;
                }

                if (mes == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Servicio de ' + model.servicio.nombre,
                        'html': 'Por favor seleccione el mes correspondiente.'
                    });

                    return false;
                }

                return true;
            }

            /*************** Fin de Validación/Guardado al generar el folio ************/

            /********************************** Agregar/Cambiar Facturas *************************************/
                $(document).on('click', '.update_factura', function () {
                    var id = $(this).data('factura');
                    $("#idFactura").val(id);
                    $('#modal-ver-facturas').modal('hide');
                    $("#modal-facturas").modal('show');
                });

                $(document).on('click', '.eliminarFactura', function () {
                    var id = $(this).data('factura');
                    var folio = $(this).data('folio');

                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Servicio de Comedor General',
                        'html': '<strong>Advertencia:</strong><p>¿Desea eliminar la factura con Folio <strong>' + folio + '</strong>?</p>',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, continuar',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(yes => {
                        if (yes.isConfirmed) {
                            Swal.fire({
                                'icon': 'warning',
                                'title': 'Servicio de Comedor General',
                                'text': 'Escriba la palabra ELIMINAR en mayúsculas para confirmar el borrado de la factura con folio: ' + folio,
                                'confirmButtonColor': '#3085d6',
                                'cancelButtonColor': '#d33',
                                'confirmButtonText': 'Si, eliminar',
                                'cancelButtonText': 'Cancelar',
                                'showCancelButton': true,
                                'input': 'text',
                                'inputPlaceholder': 'Escribe la palabra ELIMINAR'
                            }).then(del => {
                                if (del.value == 'ELIMINAR' || del.value == 'eliminar') {
                                    axios.delete('/facturas/deleteFactura/' + id).then(del => {
                                        Swal.fire({
                                            'icon': 'success',
                                            'title': 'Servicio de Comedor General',
                                            'html': 'La factura fue eliminada exitósamente.',
                                        }).then(function () {
                                            window.location.reload();
                                        });
                                    })
                                } else {
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Comedor General',
                                        'html': 'La factura no fue eliminada exitósamente, favor de escribir correctamente la palabra <b>ELIMINAR</b>',
                                    });
                                }
                            });
                        }
                    });
                });

                $(".file_factura").change(function (e) {
                    var archivo = e.target.files[0];
                    var fileName = $(this).val().split("\\").pop();
                    var ext = fileName.split('.').pop();
                    if (ext == "xml" || ext == "XML") {
                        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                        if ($('.file_factura').hasClass('is-invalid')) {
                            $('.file_factura').removeClass('is-invalid');
                            $('.file_factura').addClass('is-valid');
                            $('.error_customFile').css('display', 'none')
                        } else {
                            $('.file_factura').addClass('is-valid');
                        }
                    } else {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Servicio de Comedor General',
                            'text': 'El archivo que intenta adjuntar no es válido. Favor de solo seleccionar archivos "Xml"'
                        });

                        $(".custom-file-label").text("Seleccionar Archivo");
                        document.getElementById('customFile').value = '';

                        if ($('.file_factura').hasClass('is-valid')) {
                            $('.file_factura').removeClass('is-valid');
                            $('.file_factura').addClass('is-invalid');
                        }
                        $('.file_factura').addClass('is-invalid');
                        $('.error_customFile').css('display', 'block');
                    }
                });

                function validaCamposArchivoXml() {
                    if ($('#tipoFactura').val() == "" && $("#idFactura").val() == "") {
                        $('#tipoFactura').addClass('is-invalid');
                        $('.error_tipoFactura').css('display', 'block');
                        return false;
                    }

                    if ($('.file_factura').val() == "") {
                        $('.file_factura').addClass('is-invalid');
                        $('.error_customFile').css('display', 'block');
                        return false;
                    }
                    return true;
                }

                    $('#agregarFactura').click(function () {
                        var id = $("#idFactura").val();
                        var tipo = "Factura";

                         var formData = new FormData();
                         var file = document.getElementById('fileFactura').files[0];

                         if (id.length > 0) {
                             id = parseInt(id);
                         } else {
                             id = 0;
                         }

                         formData.append("Id", id);
                         formData.append("ServicioId", model.servicio.id);
                         formData.append("SBasicosId", model.id);
                         formData.append("Tipo", tipo);
                         formData.append("Xml", file);
                         if (validaCamposArchivoXml() == true) {
                             if (id == "") {
                                 axios.post('/facturas/insertaFacturaSB', formData).then(fact => {
                                     if (fact.data == 1) {
                                         Swal.fire({
                                             'icon': "success",
                                             'title': 'Servicio de ' + model.servicio.nombre,
                                             'html': 'La factura fue agregada correctamente.'
                                         }).then(function () {
                                             window.location.reload();
                                         });
                                     } else if (fact.data != 1 && fact.data != -1 ) {
                                         Swal.fire({
                                             'icon': "error",
                                             'title': 'Servicio de ' + model.servicio.nombre,
                                             'html': '<p style="text-align: justify">La factura que intenta adjuntar ya fue agregada previamente en la cédula con los siguientes datos: <br />' +
                                                 '<li> <b>Folio: </b>' + fact.data.folio + '</li>' +
                                                 '<li> <b>Inmueble: </b>' + fact.data.inmuebles.nombre + '</li></p>'
                                         });
                                     }
                                 }).catch(error => {
                                     Swal.fire({
                                         'icon': "error",
                                         'title': 'Servicio de ' + model.servicio.nombre,
                                         'html': '<p style="text-align: justitfy;">CASESG no puede adjuntar la factura, Contacte al administrador del Sistema.'
                                     });
                                 });
                             } else {
                                 axios.post('/facturas/updateFacturaSB', formData).then(fact => {
                                     if (fact.data == 1) {
                                         Swal.fire({
                                             'icon': "success",
                                             'title': 'Servicio de ' + model.servicio.nombre,
                                             'html': 'La factura fue actualizada correctamente.'
                                         }).then(function () {
                                             window.location.reload();
                                         });
                                     } else if (fact.data != 1 && fact.data != -1) {
                                         Swal.fire({
                                             'icon': "error",
                                             'title': 'Servicio de ' + model.servicio.nombre,
                                             'html': '<p style="text-align: justify">La factura que intenta adjuntar ya fue agregada previamente en la cédula con los siguientes datos: <br />' +
                                                     '<li> <b>Folio: </b>' + fact.data.folio + '</li>'+
                                                     '<li> <b>Inmueble: </b>' + fact.data.inmuebles.nombre + '</li></p>'
                                         });
                                     }
                                 }).catch(error => {
                                     Swal.fire({
                                         'icon': "error",
                                         'title': 'Servicio de ' + model.servicio.nombre,
                                         'html': '<p style="text-align: justitfy;">CASESG no puede adjuntar la factura, Contacte al administrador del Sistema.'
                                     });
                                 });
                             }
                        }
                        document.getElementById('customFile').value = '';
                        $('#idFactura').val("");
                        $(".custom-file .custom-file-label").text("Subir archivo \"XML\"");
                        $('.file_factura').removeClass('is-valid');
                        $("#tipoFactura").val('');
                    });
                /*FIN del proceso para editar la cedula*/

                /*Ver Facturas*/
                    $("#btn_facturas").click(function () {
                        axios.get('/limpieza/getFacturas/' + model.id + '/' + model.servicioId).then(table => {
                            var facturas = table.data;
                            for (var i = 0; i < facturas.length; i++) {
                                table += "<tr>" +
                                        "<td>" + (i + 1) + "</td>" +
                                        "<td>" + facturas[i].tipo + "</td>" +
                                        "<td>" + facturas[i].emisor.nombre + "</td>" +
                                        "<td>" + facturas[i].timbreFiscal.uuid + "</td>" +
                                        "<td>" + (facturas[i].comprobante.serie + "" + facturas[i].comprobante.folio) + "</td>" +
                                        "<td> $" + parseFloat(facturas[i].comprobante.subTotal).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                        "<td> $" + parseFloat(facturas[i].comprobante.total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                    "<td>" +
                                "<a class='view_factura' href='#' data-id='" + i + "'><i class='far fa-list text-success'></i></a>" +
                                "<a class='update_factura' href='#' data-id='" + facturas[i].id + "'><i class='fad fa-pencil text-primary ml-2'></i></a>" +
                                "</td>" +
                                "</tr>";
                            }
                            $("#listaFacturas").html(table);
                            if (facturas.length == 0) {
                                $("#listado_facturas").hide();
                            } else {
                                $("#listado_facturas").show();
                            }
                        });
                        $('#modal-ver-facturas').modal('show');
                    });
                /*Fin de Ver Facturas*/

                /*Agregar Facturas*/
                    $('#add_facturas').click(function () {
                        $("#idFactura").val('');
                        $('#modal-ver-facturas').modal('hide');
                        $('#modal-facturas').modal('show');
                    });
                /*Fin Agregar Facturas*/

                 /*Ver/Ocultar Conceptos de Factura*/
                    $('.viewConceptosF').click(function () {
                        let factura = $(this).data('factura');
                        if ($("#conceptoFactura_" + factura).css('display') == 'none')
                        {
                            $("#conceptoFactura_" + factura).css("display", "block");
                        }
                        else
                        {
                            $("#conceptoFactura_" + factura).css("display", "none");
                        }
                    });
                /*Fin Ver/Ocultar Conceptos de Factura*/

                /*Ver/Ocultar Conceptos*/
                     $(".viewConceptosF").click(function () {
                         if ($("#viewConceptos_"+$(this).data('factura')+" > i").hasClass("text-success")) {
                             $("#viewConceptos_" + $(this).data('factura') + " > i").removeClass("text-success");
                             $("#viewConceptos_" + $(this).data('factura') + "> i").addClass("text-danger");
                         } else {
                             $("#viewConceptos_" + $(this).data('factura') +" > i").removeClass("text-danger");
                             $("#viewConceptos_"+$(this).data('factura')+" > i").addClass("text-success");
                        }
                    });
                /*Fin de Ver/Ocultar Conceptos*/


            /******************************* FIN Agregar/Cambiar Facturas **********************************/

            /*************** Editar Captura ************/
            if (model.id != 0) {
                $('#select_anio').val(model.anio);
                $('#select_mes').val(model.mes);
                $('#custom-file-labelPDF').text(model.nombrePDF);
                $('#facturaId').val(model.id);
            }
            /*************** Fin de Editar Captura ************/

            /***************************** Emntregables Servicios Básicos*****************************/
                $('#error_tipoEntre').css('display', 'none');
                $('#error_customFile').css('display', 'none');
                $('#error_comentariosEntre').css('display', 'none');

                axios.get("/entregableSB/getEntregables/"+model.id).then(response => {
                    if (response.data == null || response.data == "") {
                        $('#tEntregables').html(response.data);
                    }
                    $('#tEntregables').html(response.data);
                });

                $('.btn_addFile').click(function () {
                    $('#customFile').removeClass('is-valid');
                    $('#comentarios_entregable').removeClass('is-valid');
                    $('#tipo_entregable').removeClass('is-valid');
                    $('#customFile').removeClass('is-invalid');
                    $('#comentarios_entregable').removeClass('is-invalid');
                    $('#tipo_entregable').removeClass('is-invalid');
                    $('#error_tipoEntre').css('display', 'none');
                    $('#error_customFile').css('display', 'none');
                    $('#error_comentariosEntre').css('display', 'none');
                    $('#modal_evidencias').modal('show');
                });

                function validaCamposArchivo() {
                    if ($('#tipo_entregable').val() == "" && $('#customFile').val() == "") {
                        $('#tipo_entregable').addClass('is-invalid');
                        $('#error_tipoEntre').css('display', 'block');
                        $('#customFile').addClass('is-invalid');
                        $('#error_customFile').css('display', 'block');
                        return false;
                    }

                    if ($('#tipo_entregable').val() == "") {
                        $('#tipo_entregable').addClass('is-invalid');
                        $('#error_tipoEntre').css('display', 'block');
                        return false;
                    }

                    if (($('#customFile').val() == "" && $('.custom-file-label').text() == "")) {
                        $('#customFile').addClass('is-invalid');
                        $('#error_customFile').css('display', 'block');
                        return false;
                    }

                    return true;
                }

                $("#customFile").on("change", function () {
                    var fileName = $(this).val().split("\\").pop();
                    var ext = fileName.split('.').pop();
                    if (ext == "pdf" || ext == "PDF") {
                        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                    } else {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Servicio de ' + model.servicio.nombre,
                            'text': 'El archivo que intenta adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                        });
                        $(".custom-file-label").text("Seleccionar Archivo");
                        document.getElementById('customFile').value = '';
                        if ($('#customFile').hasClass('is-valid')) {
                            $('#customFile').removeClass('is-valid');
                        }
                        $('#customFile').addClass('is-invalid');
                        $('#error_customFile').css('display', 'block');
                    }
                });

                $('#tipo_entregable').change(function () {
                    if ($('#tipo_entregable').val() == "") {
                        $('#tipo_entregable').addClass('is-invalid');
                        $('#error_tipoEntre').css('display', 'block');
                        return false;
                    } else {
                        $('#tipo_entregable').removeClass('is-invalid');
                        $('#tipo_entregable').addClass('is-valid');
                        $('#error_tipoEntre').css('display', 'none');
                    }
                });

                $('#customFile').change(function () {
                    if ($('#customFile').val() == "") {
                        $('#customFile').addClass('is-invalid');
                        $('#error_customFile').css('display', 'block');
                    } else {
                        var fileName = $("#customFile").val().split("\\").pop();
                        var ext = fileName.split('.').pop();
                        if (ext != "pdf") {
                            $('#customFile').addClass('is-invalid');
                            $('#error_customFile').css('display', 'block');
                        } else {
                            $('#customFile').removeClass('is-invalid');
                            $('#customFile').addClass('is-valid');
                            $('#error_customFile').css('display', 'none');
                        }
                    }
                });

                $('#comentarios_entregable').change(function () {
                    if ($('#comentarios_entregable').val() == "") {
                        $('#comentarios_entregable').addClass('is-invalid');
                        $('#error_comentariosEntre').css('display', 'block');
                        return false;
                    } else {
                        $('#comentarios_entregable').removeClass('is-invalid');
                        $('#comentarios_entregable').addClass('is-valid');
                        $('#error_comentariosEntre').css('display', 'none');
                    }
                });

                $('#adjuntarArchivo').click(function () {
                    var formData = new FormData();
                    var file = document.getElementById('customFile').files[0];
                    var id = $('#file_id').val();
                    var tipo = $('#tipo_entregable').val();
                    var comentarios = $('#comentarios_entregable').val();
                    var url = "inserta";

                    if (id.length > 0) {
                        id = parseInt(id);
                        url = 'actualiza'
                    } else {
                        id = 0;
                    }

                    formData.append("Id", id);
                    formData.append("ServicioBasico", model.id);
                    formData.append("NombreServicio", model.servicio.nombre);
                    formData.append("Mes", model.mes);
                    formData.append("Tipo", tipo);
                    formData.append("Comentarios", comentarios);
                    if (file != null) {
                        formData.append("Archivo", file);
                    }

                    if (validaCamposArchivo()) {
                        axios.post('/entregableSB/'+url+'EntregableSB', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                            $('#cerrar_modal_sua').trigger('click');
                            if (response.status == 200) {
                                Swal.fire({
                                    'icon': "success",
                                    'title': 'Servicio de ' + model.servicio.nombre,
                                    'text': 'Se adjuntó el archivo de correctamente.'
                                }).then(function () {
                                    axios.get("/entregableSB/getEntregables/" + model.id).then(success => {
                                        if (success.data == null || success.data == "") {
                                            $('#tEntregables').html(success.data);
                                        }
                                        $('#tEntregables').html(success.data);
                                    });
                                });
                            }
                        });
                    }
                    document.getElementById('customFile').value = '';
                    $('#file_id').val("");
                    $(".custom-file-label").text("Seleccionar Archivo");
                    $('#tipo_entregable').val('');
                    $('#comentarios_entregable').val('');
                    $('#customFile').removeClass('is-valid');
                    $('#comentarios_entregable').removeClass('is-valid');
                    $('#tipo_entregable').removeClass('is-valid');
                });

                $(document).on("click", ".update_files", function () {
                    $('#modal_evidencias').modal('show');
                    var id = $(this).data('id');
                    var tipo = $(this).data('tipo');
                    var coments = $(this).data('comentarios');
                    var file = $(this).data('file');
                    $('#file_id').val(parseInt(id));
                    $(".custom-file-label").text(file);
                    $('#tipo_entregable').val(tipo);
                    $('#comentarios_entregable').val(coments);
                    $('#modal_evidencias').modal('show');
                });

                $(document).on("click", ".delete_files", function () {
                    let id = $(this).data('id');
                    let tipo = $(this).data('tipo');
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Servicio de ' + model.servicio.nombre,
                        'text': '¿Está seguro de eliminar el archivo relacionado a "' + tipo + '"?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, Eliminar Archivo',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(response => {
                        if (response.isConfirmed) {
                            axios.post("/entregableSB/eliminaArchivo", {
                                Id: parseInt(id), Mes: model.mes, NombreServicio: model.servicio.nombre }).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Servicio de ' + model.servicio.nombre,
                                        'html': 'El archivo fue eliminado con éxito.',
                                    }).then(function () {
                                        axios.get("/entregableSB/getEntregables/" + model.id).then(response => {
                                            if (response.data == null || response.data == "") {
                                                $('#tEntregables').html(response.data);
                                            }
                                            $('#tEntregables').html(response.data);
                                        });
                                    });
                                }
                            }).catch(error => {
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de ' + model.servicio.nombre,
                                    'html': 'No se pudo procesar tu solicitud. Contacta a tu Administrador.',
                                });
                            });
                        }
                    });
                });

                $(document).on('click', '.view_file', function () {
                    let nombre = $(this).data('file');
                    let tipo = $(this).data('tipo');
                    let data = "<object width='100%' height='710px' data='/view/entregable/" + model.folio + "/" + nombre + "'></object>";
                    $('#titlePDF').text("PDF - \"" + tipo + "\"");
                    $('#objectPdf').html(data);
                    $('#show_pdf').modal('show');
                });
            /***************************** Emntregables Servicios Básicos*****************************/
        };
    </script>
}